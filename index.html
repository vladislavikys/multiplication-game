<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ - –ò–≥—Ä–∞</title>
    <!-- –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –°–ö–†–ò–ü–¢–´ (–±–µ–∑ defer –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –ø–æ—Ä—è–¥–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase - –∑–∞–≥—Ä—É–∑–∫–∞ –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        // ============================================
        // –ü–†–û–í–ï–†–ö–ê –ì–û–¢–û–í–ù–û–°–¢–ò –ë–ò–ë–õ–ò–û–¢–ï–ö
        // ============================================
        if (typeof React === 'undefined' || typeof ReactDOM === 'undefined' || typeof firebase === 'undefined') {
          console.error('–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ –≤—Å–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!', {
            React: typeof React !== 'undefined',
            ReactDOM: typeof ReactDOM !== 'undefined',
            firebase: typeof firebase !== 'undefined'
          });

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
          document.getElementById('root').innerHTML = `
            <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(to bottom right, #e9d5ff, #fce7f3, #bfdbfe); font-family: system-ui;">
              <div style="background: white; border-radius: 24px; padding: 32px; max-width: 400px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                <div style="font-size: 64px; margin-bottom: 16px;">‚ùå</div>
                <h1 style="color: #dc2626; font-size: 24px; font-weight: bold; margin-bottom: 16px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h1>
                <p style="color: #4b5563; margin-bottom: 24px;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p>
                <button onclick="location.reload()" style="background: linear-gradient(to right, #a855f7, #ec4899); color: white; font-weight: bold; padding: 12px 24px; border-radius: 12px; border: none; cursor: pointer; font-size: 16px;">
                  üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                </button>
              </div>
            </div>
          `;
          throw new Error('Libraries not loaded');
        }

        const { useState, useEffect, useRef } = React;

        // üî• –í–ê–®–ê FIREBASE –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        const firebaseConfig = {
          apiKey: "AIzaSyCCUcNvmsdh0nsaZler0PQCrqJfNvEHifY",
          authDomain: "multiplication-game-22120.firebaseapp.com",
          projectId: "multiplication-game-22120",
          storageBucket: "multiplication-game-22120.firebasestorage.app",
          messagingSenderId: "797459824775",
          appId: "1:797459824775:web:ce953848b79dd3889b3822"
        };

        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        function MultiplicationGame() {
          const [user, setUser] = useState(null);
          const [loading, setLoading] = useState(true);
          const [loadingStatus, setLoadingStatus] = useState(''); // –ù–û–í–û–ï: —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏
          const [authMode, setAuthMode] = useState('login');
          const [email, setEmail] = useState('');
          const [password, setPassword] = useState('');
          const [gameState, setGameState] = useState('auth');
          const [activationCode, setActivationCode] = useState('');
          const [hasLicense, setHasLicense] = useState(false);
          const [showActivation, setShowActivation] = useState(false);
          // –û–¢–ö–õ–Æ–ß–ï–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
          // const [isCheckingDevice, setIsCheckingDevice] = useState(false);

          // –ù–û–í–û–ï: 2FA —Å–æ—Å—Ç–æ—è–Ω–∏—è
          const [pending2FA, setPending2FA] = useState(false);
          const [twoFactorCode, setTwoFactorCode] = useState('');
          const [userCredentialTemp, setUserCredentialTemp] = useState(null);
          const [generated2FACode, setGenerated2FACode] = useState('');
          const [totalRounds, setTotalRounds] = useState(10);
          const [operations, setOperations] = useState({
            multiply: true,
            divide: false,
            add: false,
            subtract: false
          });
          const [num1, setNum1] = useState(0);
          const [num2, setNum2] = useState(0);
          const [currentOperation, setCurrentOperation] = useState('√ó');
          const [answer, setAnswer] = useState('');
          const [score, setScore] = useState(0);
          const [currentRound, setCurrentRound] = useState(0);
          const [message, setMessage] = useState('');
          const [streak, setStreak] = useState(0);
          const [bestStreak, setBestStreak] = useState(0);
          const [soundEnabled, setSoundEnabled] = useState(true);
          const [attempts, setAttempts] = useState(2);
          const [lives, setLives] = useState(2);
          const [gameHistory, setGameHistory] = useState([]);

          // –ù–û–í–û–ï: –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
          const [notifications, setNotifications] = useState([]);

          const audioContextRef = useRef(null);
          const notificationIdRef = useRef(0);

          // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Device ID (—É–ª—É—á—à–µ–Ω–Ω—ã–π fingerprint —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)
          const getDeviceId = () => {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
              // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π fingerprint –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –±—Ä–∞—É–∑–µ—Ä–∞
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              ctx.textBaseline = 'top';
              ctx.font = '14px Arial';
              ctx.fillText('fingerprint', 2, 2);
              const canvasFingerprint = canvas.toDataURL().slice(-50);

              const fingerprint = [
                navigator.userAgent,
                navigator.language,
                screen.width,
                screen.height,
                screen.colorDepth,
                new Date().getTimezoneOffset(),
                canvasFingerprint,
                Date.now(),
                Math.random().toString(36)
              ].join('|');

              // –°–æ–∑–¥–∞–µ–º –∫–æ—Ä–æ—Ç–∫–∏–π hash
              let hash = 0;
              for (let i = 0; i < fingerprint.length; i++) {
                const char = fingerprint.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
              }

              deviceId = 'device_' + Math.abs(hash).toString(36) + '_' + Date.now();
              localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
          };

          // –ü–æ–ª—É—á–µ–Ω–∏–µ IP –∞–¥—Ä–µ—Å–∞ (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ)
          const getDeviceInfo = async () => {
            console.log('üåê getDeviceInfo: –ù–∞—á–∞–ª–æ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ');
            const deviceId = getDeviceId();
            const userAgent = navigator.userAgent;
            const platform = navigator.platform;
            const language = navigator.language;

            // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å IP (–±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å) —Å –¢–ê–ô–ú–ê–£–¢–û–ú
            let ipAddress = 'unknown';
            try {
              console.log('üåç –ó–∞–ø—Ä–æ—Å IP –∞–¥—Ä–µ—Å–∞ —Å api.ipify.org (—Ç–∞–π–º–∞—É—Ç 3 —Å–µ–∫)...');

              // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–º–∞—É—Ç –Ω–∞ fetch
              const controller = new AbortController();
              const timeoutId = setTimeout(() => {
                console.warn('‚è±Ô∏è –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ IP (3 —Å–µ–∫), –ø—Ä–µ—Ä—ã–≤–∞–µ–º');
                controller.abort();
              }, 3000); // 3 —Å–µ–∫—É–Ω–¥—ã —Ç–∞–π–º–∞—É—Ç

              const response = await fetch('https://api.ipify.org?format=json', {
                signal: controller.signal
              });
              clearTimeout(timeoutId);

              const data = await response.json();
              ipAddress = data.ip;
              console.log('‚úÖ IP –∞–¥—Ä–µ—Å –ø–æ–ª—É—á–µ–Ω:', ipAddress);
            } catch (e) {
              if (e.name === 'AbortError') {
                console.warn('‚è±Ô∏è –ó–∞–ø—Ä–æ—Å IP –ø—Ä–µ—Ä–≤–∞–Ω –ø–æ —Ç–∞–π–º–∞—É—Ç—É (>3 —Å–µ–∫), –∏—Å–ø–æ–ª—å–∑—É–µ–º unknown');
              } else {
                console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å IP:', e.message);
              }
            }

            console.log('‚úÖ getDeviceInfo –∑–∞–≤–µ—Ä—à–µ–Ω:', { deviceId, ipAddress, platform });
            return {
              deviceId,
              userAgent,
              platform,
              language,
              ipAddress,
              lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            };
          };

          // ============================================
          // –ù–û–í–û–ï: –°–ò–°–¢–ï–ú–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô
          // ============================================

          const showNotification = (message, type = 'info', duration = 5000) => {
            const id = notificationIdRef.current++;
            const notification = { id, message, type, duration };

            setNotifications(prev => [...prev, notification]);

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ duration
            setTimeout(() => {
              setNotifications(prev => prev.filter(n => n.id !== id));
            }, duration);
          };

          // ============================================
          // –ù–û–í–û–ï: –ö–≠–®–ò–†–û–í–ê–ù–ò–ï –î–ê–ù–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
          // ============================================

          const cacheUserData = (userId, data) => {
            try {
              const cacheKey = `user_cache_${userId}`;
              const cacheData = {
                data,
                timestamp: Date.now(),
                version: 1
              };
              localStorage.setItem(cacheKey, JSON.stringify(cacheData));
            } catch (e) {
              console.log('Cache error:', e);
            }
          };

          const getCachedUserData = (userId) => {
            try {
              const cacheKey = `user_cache_${userId}`;
              const cached = localStorage.getItem(cacheKey);
              if (!cached) return null;

              const { data, timestamp, version } = JSON.parse(cached);
              const cacheAge = Date.now() - timestamp;
              const maxAge = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç

              // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤–µ–∂–µ—Å—Ç—å –∫—ç—à–∞
              if (cacheAge > maxAge || version !== 1) {
                localStorage.removeItem(cacheKey);
                return null;
              }

              return data;
            } catch (e) {
              console.log('Cache read error:', e);
              return null;
            }
          };

          const clearUserCache = (userId) => {
            try {
              const cacheKey = `user_cache_${userId}`;
              localStorage.removeItem(cacheKey);
            } catch (e) {
              console.log('Cache clear error:', e);
            }
          };

          // ============================================
          // –ù–û–í–û–ï: –î–í–£–•–§–ê–ö–¢–û–†–ù–ê–Ø –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø (2FA)
          // ============================================

          // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è 6-–∑–Ω–∞—á–Ω–æ–≥–æ –∫–æ–¥–∞
          const generate2FACode = () => {
            return Math.floor(100000 + Math.random() * 900000).toString();
          };

          // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ –Ω–∞ email (–∏—Å–ø–æ–ª—å–∑—É–µ–º Firebase Admin –∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –∫–æ–Ω—Å–æ–ª–∏)
          const send2FAEmail = async (email, code) => {
            console.log('üìß ========================================');
            console.log('üìß –û–¢–ü–†–ê–í–ö–ê 2FA –ö–û–î–ê –ù–ê EMAIL:', email);
            console.log('üìß –ö–û–î:', code);
            console.log('üìß ========================================');

            // –î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª–∏ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏
            showNotification(
              `üîê –ö–û–î –î–í–£–•–§–ê–ö–¢–û–†–ù–û–ô –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò\n\n` +
              `–í–∞—à –∫–æ–¥: ${code}\n\n` +
              `(–í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ email ${email})\n\n` +
              `–ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 5 –º–∏–Ω—É—Ç.`,
              'info',
              30000 // 30 —Å–µ–∫—É–Ω–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
            );

            // TODO: –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —á–µ—Ä–µ–∑ EmailJS –∏–ª–∏ Firebase Extension
            // –ü—Ä–∏–º–µ—Ä —Å EmailJS:
            // await emailjs.send('service_id', 'template_id', {
            //   to_email: email,
            //   code: code
            // });

            return true;
          };

          // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ –≤ Firestore —Å TTL
          const save2FACode = async (userId, code) => {
            console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ 2FA –∫–æ–¥–∞ –≤ Firestore –¥–ª—è userId:', userId);
            const expireAt = new Date(Date.now() + 5 * 60 * 1000); // 5 –º–∏–Ω—É—Ç

            await db.collection('twoFactorCodes').doc(userId).set({
              code: code,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              expireAt: expireAt,
              used: false
            });

            console.log('‚úÖ 2FA –∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –∏—Å—Ç–µ–∫–∞–µ—Ç:', expireAt);
          };

          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
          const verify2FACode = async (userId, inputCode) => {
            console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ 2FA –∫–æ–¥–∞ –¥–ª—è userId:', userId);
            console.log('üîç –í–≤–µ–¥–µ–Ω–Ω—ã–π –∫–æ–¥:', inputCode);

            const codeDoc = await db.collection('twoFactorCodes').doc(userId).get();

            if (!codeDoc.exists) {
              console.error('‚ùå –ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ');
              return { success: false, message: '–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ —Å–Ω–æ–≤–∞.' };
            }

            const codeData = codeDoc.data();
            console.log('üìÑ –î–∞–Ω–Ω—ã–µ –∫–æ–¥–∞ –∏–∑ –±–∞–∑—ã:', codeData);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ª–∏ –∫–æ–¥
            if (codeData.used) {
              console.error('‚ùå –ö–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω');
              return { success: false, message: '–≠—Ç–æ—Ç –∫–æ–¥ —É–∂–µ –±—ã–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω.' };
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∏—Å—Ç–µ–∫ –ª–∏ —Å—Ä–æ–∫
            const now = new Date();
            const expireAt = codeData.expireAt.toDate();
            if (now > expireAt) {
              console.error('‚ùå –ö–æ–¥ –∏—Å—Ç–µ–∫. Expire:', expireAt, 'Now:', now);
              return { success: false, message: '–ö–æ–¥ –∏—Å—Ç–µ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ —Å–Ω–æ–≤–∞.' };
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ –∫–æ–¥
            if (codeData.code !== inputCode) {
              console.error('‚ùå –ö–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π. Expected:', codeData.code, 'Got:', inputCode);
              return { success: false, message: '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞.' };
            }

            // –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—à–ª–∏ - –ø–æ–º–µ—á–∞–µ–º –∫–æ–¥ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π
            await db.collection('twoFactorCodes').doc(userId).update({
              used: true,
              usedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            console.log('‚úÖ 2FA –∫–æ–¥ –≤–µ—Ä–Ω—ã–π –∏ –ø—Ä–∏–Ω—è—Ç');
            return { success: true };
          };

          // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏ (–£–ü–†–û–©–ï–ù–û - –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
          const updateSession = async (userId) => {
            console.log('üîÑ updateSession: –ù–∞—á–∞–ª–æ –¥–ª—è userId:', userId);

            try {
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –∞–∫–∫–∞—É–Ω—Ç–∞
              console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞...');
              const userDoc = await db.collection('users').doc(userId).get();

              if (userDoc.exists && userDoc.data().blocked) {
                console.error('üö´ –ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!');
                showNotification('üö´ –í–ê–® –ê–ö–ö–ê–£–ù–¢ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù\n\n–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.', 'error', 8000);
                await auth.signOut();
                return;
              }

              // –ü—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Å—Å–∏—é –ë–ï–ó –ø—Ä–æ–≤–µ—Ä–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
              console.log('üì± –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ...');
              const deviceInfo = await getDeviceInfo();

              console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –≤ Firestore...');
              await db.collection('sessions').doc(userId).set({
                ...deviceInfo,
                userId,
                isActive: true,
                lastLoginAt: firebase.firestore.FieldValue.serverTimestamp()
              });

              console.log('‚úÖ updateSession: –°–µ—Å—Å–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
            } catch (error) {
              console.error('‚ùå updateSession: –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏:', error);
            }
          };

          // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
          const logSecurityEvent = async (userId, eventType, details) => {
            try {
              await db.collection('security_logs').add({
                userId,
                eventType,
                details,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                deviceId: getDeviceId(),
                ...await getDeviceInfo()
              });

              // –û–¢–ö–õ–Æ–ß–ï–ù–û: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ sharing –∞–∫–∫–∞—É–Ω—Ç–∞
              // if (eventType === 'concurrent_login_attempt') {
              //   await checkForAccountSharing(userId);
              // }
            } catch (error) {
              console.error('Error logging security event:', error);
            }
          };

          // ============================================
          // –û–¢–ö–õ–Æ–ß–ï–ù–û: –í–°–ï –§–£–ù–ö–¶–ò–ò –ü–†–û–í–ï–†–ö–ò –£–°–¢–†–û–ô–°–¢–í
          // –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 2FA –≤–º–µ—Å—Ç–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
          // ============================================

          /*
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ sharing –∞–∫–∫–∞—É–Ω—Ç–∞ (–∞–≤—Ç–æ–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)
          const checkForAccountSharing = async (userId) => {
            try {
              const last24h = new Date(Date.now() - 24 * 60 * 60 * 1000);
              const last1h = new Date(Date.now() - 60 * 60 * 1000);

              // –ü–æ–ª—É—á–∞–µ–º –ª–æ–≥–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
              const logsSnapshot = await db.collection('security_logs')
                .where('userId', '==', userId)
                .where('eventType', '==', 'concurrent_login_attempt')
                .where('timestamp', '>=', last24h)
                .get();

              const logs = logsSnapshot.docs.map(doc => doc.data());

              // –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω 1: –ë–æ–ª–µ–µ 5 –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞ —Å —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∑–∞ 24 —á–∞—Å–∞
              const uniqueDevices = new Set(logs.map(log => log.deviceId));
              if (uniqueDevices.size >= 5) {
                await db.collection('users').doc(userId).update({ blocked: true });
                await logSecurityEvent(userId, 'auto_blocked_sharing', {
                  reason: '–ë–æ–ª–µ–µ 5 —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∑–∞ 24 —á–∞—Å–∞',
                  deviceCount: uniqueDevices.size
                });
                return;
              }

              // –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω 2: –ë–æ–ª–µ–µ 10 –ø–æ–ø—ã—Ç–æ–∫ –° –†–ê–ó–ù–´–• —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∑–∞ 1 —á–∞—Å
              const recentLogs = logs.filter(log => log.timestamp && log.timestamp.toDate() >= last1h);
              const recentUniqueDevices = new Set(recentLogs.map(log => log.deviceId).filter(d => d));
              if (recentUniqueDevices.size >= 10) {
                await db.collection('users').doc(userId).update({ blocked: true });
                await logSecurityEvent(userId, 'auto_blocked_sharing', {
                  reason: '–ë–æ–ª–µ–µ 10 —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∑–∞ 1 —á–∞—Å',
                  deviceCount: recentUniqueDevices.size
                });
                return;
              }

              // –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω 3: –†–∞–∑–Ω—ã–µ IP –∞–¥—Ä–µ—Å–∞ –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–∞–Ω (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
              const uniqueIPs = new Set(logs.map(log => log.ipAddress).filter(ip => ip && ip !== 'unknown'));
              if (uniqueIPs.size >= 3) {
                // 3+ —Ä–∞–∑–Ω—ã—Ö IP –∑–∞ 24 —á–∞—Å–∞ - –≤—ã—Å–æ–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å sharing
                await logSecurityEvent(userId, 'suspicious_multiple_ips', {
                  ipCount: uniqueIPs.size,
                  ips: Array.from(uniqueIPs)
                });
              }
            } catch (error) {
              console.error('Error checking for account sharing:', error);
            }
          };

          // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–∞—Å—Ç–æ—Ç—ã —Å–º–µ–Ω—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤
          const checkDeviceSwitchLimit = async (userId) => {
            try {
              const today = new Date();
              today.setHours(0, 0, 0, 0);

              const logsSnapshot = await db.collection('security_logs')
                .where('userId', '==', userId)
                .where('eventType', '==', 'device_switch')
                .where('timestamp', '>=', today)
                .get();

              const switchCount = logsSnapshot.size;

              // –ú–∞–∫—Å–∏–º—É–º 3 —Å–º–µ–Ω—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ –¥–µ–Ω—å
              if (switchCount >= 3) {
                showNotification('‚ö†Ô∏è –ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–ê–Ø –ê–ö–¢–ò–í–ù–û–°–¢–¨!\n\n–í—ã –ø—Ä–µ–≤—ã—Å–∏–ª–∏ –ª–∏–º–∏—Ç —Å–º–µ–Ω—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (3 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å). –≠—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –ø–æ–ø—ã—Ç–∫–∞ —Ä–∞—Å—à–∞—Ä–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç.\n\n–î–æ—Å—Ç—É–ø –≤—Ä–µ–º–µ–Ω–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.', 'error', 10000);
                await logSecurityEvent(userId, 'device_limit_exceeded', {
                  switchCount,
                  blocked: true
                });
                return false;
              }

              return true;
            } catch (error) {
              console.error('Error checking device switch limit:', error);
              return true;
            }
          };

          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤—Ö–æ–¥–æ–≤ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º –≤—Ö–æ–¥–µ)
          const checkAndSwitchDevice = async (userId) => {
            const deviceId = getDeviceId();
            console.log('üîç checkAndSwitchDevice: deviceId =', deviceId);

            try {
              const sessionDoc = await db.collection('sessions').doc(userId).get();
              console.log('üìÑ Session doc exists:', sessionDoc.exists);

              if (sessionDoc.exists) {
                const sessionData = sessionDoc.data();
                console.log('üìä Session data:', {
                  deviceId: sessionData.deviceId,
                  isActive: sessionData.isActive,
                  lastSeen: sessionData.lastSeen?.toDate?.()
                });

                // –ï—Å–ª–∏ —ç—Ç–æ –¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏ –æ–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ
                if (sessionData.deviceId !== deviceId && sessionData.isActive) {
                  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –æ–±–Ω–æ–≤–ª—è–ª–∞—Å—å —Å–µ—Å—Å–∏—è
                  const now = Date.now();
                  const lastSeen = sessionData.lastSeen?.toDate?.()?.getTime() || 0;
                  const timeSinceLastSeen = now - lastSeen;
                  const fiveMinutes = 5 * 60 * 1000; // –£–í–ï–õ–ò–ß–ï–ù–û: 5 –º–∏–Ω—É—Ç –≤–º–µ—Å—Ç–æ 1

                  console.log('‚è±Ô∏è Time since last seen:', Math.floor(timeSinceLastSeen / 1000), '—Å–µ–∫—É–Ω–¥');

                  // –°–õ–£–ß–ê–ô 1: –°—Ç–∞—Ä–∞—è —Å–µ—Å—Å–∏—è (–Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∞—Å—å > 5 –º–∏–Ω—É—Ç) - —Å—á–∏—Ç–∞–µ–º –º–µ—Ä—Ç–≤–æ–π
                  if (timeSinceLastSeen > fiveMinutes || !sessionData.lastSeen) {
                    console.log('‚úÖ –°—Ç–∞—Ä–∞—è —Å–µ—Å—Å–∏—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ (–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞ >5 –º–∏–Ω), –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º');

                    // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å—Ç–∞—Ä—É—é —Å–µ—Å—Å–∏—é
                    await db.collection('sessions').doc(userId).update({
                      isActive: false,
                      replacedBy: deviceId,
                      replacedAt: firebase.firestore.FieldValue.serverTimestamp(),
                      reason: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è —Å—Ç–∞—Ä–æ–π —Å–µ—Å—Å–∏–∏ (>5 –º–∏–Ω)'
                    });

                    // –õ–æ–≥–∏—Ä—É–µ–º
                    await logSecurityEvent(userId, 'old_session_replaced', {
                      oldDevice: sessionData.deviceId,
                      newDevice: deviceId,
                      timeSinceLastSeen: Math.floor(timeSinceLastSeen / 1000) + ' —Å–µ–∫—É–Ω–¥'
                    });

                    // –ü–£–°–ö–ê–ï–ú –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    return true;
                  }

                  // –°–õ–£–ß–ê–ô 2: –°–≤–µ–∂–∞—è —Å–µ—Å—Å–∏—è (–∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) - –¥–∞–µ–º –≤—ã–±–æ—Ä
                  console.log('‚ö†Ô∏è –ê–ö–¢–ò–í–ù–ê–Ø –°–ï–°–°–ò–Ø –Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ (<5 –º–∏–Ω)');

                  // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ø—ã—Ç–∫—É
                  await logSecurityEvent(userId, 'concurrent_login_attempt', {
                    currentDevice: deviceId,
                    activeDevice: sessionData.deviceId,
                    currentIP: (await getDeviceInfo()).ipAddress,
                    activeIP: sessionData.ipAddress,
                    timeSinceLastSeen: Math.floor(timeSinceLastSeen / 1000) + ' —Å–µ–∫—É–Ω–¥'
                  });

                  // –î–ê–ï–ú –í–´–ë–û–† –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                  console.log('‚ùì –ü–æ–∫–∞–∑—ã–≤–∞–µ–º confirm –¥–∏–∞–ª–æ–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é...');
                  const userChoice = confirm(
                    '‚ö†Ô∏è –û–ë–ù–ê–†–£–ñ–ï–ù–ê –ê–ö–¢–ò–í–ù–ê–Ø –°–ï–°–°–ò–Ø\n\n' +
                    '–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.\n\n' +
                    'üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ' + (sessionData.platform || 'Unknown') + '\n' +
                    'üïê –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ' + Math.floor(timeSinceLastSeen / 1000) + ' —Å–µ–∫ –Ω–∞–∑–∞–¥\n\n' +
                    '‚ùì –í—ã–∫–∏–Ω—É—Ç—å –¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏ –≤–æ–π—Ç–∏?\n\n' +
                    '–û–ö = –î–∞, –≤—ã–∫–∏–Ω—É—Ç—å –∏ –≤–æ–π—Ç–∏\n' +
                    '–û—Ç–º–µ–Ω–∞ = –ù–µ—Ç, –æ—Å—Ç–∞–≤–∏—Ç—å –¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ'
                  );

                  console.log('üí¨ –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userChoice ? '–û–ö (–≤–æ–π—Ç–∏)' : '–û—Ç–º–µ–Ω–∞');

                  if (userChoice) {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –í–´–ö–ò–ù–£–¢–¨ –¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
                    console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –∑–∞–º–µ–Ω—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞');

                    // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å—Ç–∞—Ä—É—é —Å–µ—Å—Å–∏—é
                    await db.collection('sessions').doc(userId).update({
                      isActive: false,
                      replacedBy: deviceId,
                      replacedAt: firebase.firestore.FieldValue.serverTimestamp(),
                      reason: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –∑–∞–º–µ–Ω—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞'
                    });

                    // –õ–æ–≥–∏—Ä—É–µ–º
                    await logSecurityEvent(userId, 'device_switch_confirmed', {
                      oldDevice: sessionData.deviceId,
                      newDevice: deviceId
                    });

                    showNotification('‚úÖ –í—Ö–æ–¥ —Ä–∞–∑—Ä–µ—à–µ–Ω\n\n–°—Ç–∞—Ä–∞—è —Å–µ—Å—Å–∏—è –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞.', 'success', 3000);

                    // –ü–£–°–ö–ê–ï–ú –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    return true;
                  } else {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –ù–ï –í–•–û–î–ò–¢–¨
                    console.log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –≤—Ö–æ–¥');

                    // –í—ã—Ö–æ–¥–∏–º
                    await auth.signOut();
                    setUser(null);
                    setGameState('auth');

                    showNotification('‚ÑπÔ∏è –í—Ö–æ–¥ –æ—Ç–º–µ–Ω–µ–Ω\n\n–í—Ç–æ—Ä–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Å—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º.', 'info', 4000);

                    throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –≤—Ö–æ–¥');
                  }
                } else {
                  console.log('‚úÖ –≠—Ç–æ —Ç–æ –∂–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–ª–∏ —Å–µ—Å—Å–∏—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞');
                }
              } else {
                console.log('‚úÖ –°–µ—Å—Å–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é');
              }

              return true;
            } catch (error) {
              console.error('‚ùå Error checking devices:', error);
              throw error;
            }
          };
          */
          // ============================================
          // –ö–û–ù–ï–¶ –û–¢–ö–õ–Æ–ß–ï–ù–ù–´–• –§–£–ù–ö–¶–ò–ô –ü–†–û–í–ï–†–ö–ò –£–°–¢–†–û–ô–°–¢–í
          // ============================================

          useEffect(() => {
            console.log('üöÄ useEffect: –ù–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
            console.log('üî• Firebase auth:', typeof auth !== 'undefined' ? '–ó–∞–≥—Ä—É–∂–µ–Ω' : '–ù–ï –∑–∞–≥—Ä—É–∂–µ–Ω');
            console.log('üî• Firebase db:', typeof db !== 'undefined' ? '–ó–∞–≥—Ä—É–∂–µ–Ω' : '–ù–ï –∑–∞–≥—Ä—É–∂–µ–Ω');

            try {
              audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
              console.log('Audio not supported');
            }

            // ============================================
            // FALLBACK: –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ loading = false
            // ============================================
            let fallbackTriggered = false;
            const loadingFallbackTimer = setTimeout(() => {
              console.error('‚è±Ô∏è FALLBACK: –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase (15 —Å–µ–∫)');
              console.error('‚ö†Ô∏è onAuthStateChanged –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª –∑–∞ 15 —Å–µ–∫—É–Ω–¥');
              fallbackTriggered = true;
              setLoading(false);
              setLoadingStatus('');
              showNotification('‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ —Å–µ—Ä–≤–µ—Ä—É.\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ\n‚Ä¢ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5)\n‚Ä¢ –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞', 'warning', 10000);
            }, 15000); // –£–í–ï–õ–ò–ß–ï–ù–û: 15 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é Firebase

            console.log('‚è±Ô∏è –ó–∞–ø—É—â–µ–Ω fallback —Ç–∞–π–º–µ—Ä (15 —Å–µ–∫)');

            const unsubscribe = auth.onAuthStateChanged(async (user) => {
              // –û—Ç–º–µ–Ω—è–µ–º fallback —Ç–∞–π–º–µ—Ä, —Ç.–∫. Firebase —Ä–∞–±–æ—Ç–∞–µ—Ç
              console.log('üîî onAuthStateChanged —Å—Ä–∞–±–æ—Ç–∞–ª! user =', user ? user.email : 'null');

              if (fallbackTriggered) {
                console.warn('‚ö†Ô∏è Fallback —É–∂–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º onAuthStateChanged');
                return;
              }

              clearTimeout(loadingFallbackTimer);
              console.log('‚úÖ Fallback —Ç–∞–π–º–µ—Ä –æ—Ç–º–µ–Ω–µ–Ω');
              try {
                if (user) {
                  console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', user.email, 'uid:', user.uid);
                  setUser(user);

                  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ç–∞–π–º–∞—É—Ç–æ–º
                  let loadTimeoutTriggered = false;
                  const loadTimeout = setTimeout(() => {
                    console.error('‚è±Ô∏è –¢–ê–ô–ú–ê–£–¢: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–µ–≤—ã—Å–∏–ª–∞ 20 —Å–µ–∫—É–Ω–¥');
                    loadTimeoutTriggered = true;
                    setLoading(false);
                    setLoadingStatus('');
                    showNotification('‚è±Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ\n‚Ä¢ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5)', 'error', 8000);
                  }, 20000); // –£–í–ï–õ–ò–ß–ï–ù–û: 20 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç

                  console.log('üìä –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
                  await loadUserData(user);  // –ü–µ—Ä–µ–¥–∞–µ–º –≤–µ—Å—å user –æ–±—ä–µ–∫—Ç, –Ω–µ —Ç–æ–ª—å–∫–æ uid
                  console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã');

                  if (loadTimeoutTriggered) {
                    console.warn('‚ö†Ô∏è Load timeout —É–∂–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–µ—Ä—ã–≤–∞–µ–º');
                    return;
                  }

                  // –ü–†–û–í–ï–†–ö–ê: –ú–æ–∂–µ—Ç –±—ã—Ç—å signOut –ø—Ä–æ–∏–∑–æ—à–µ–ª –≤–æ –≤—Ä–µ–º—è loadUserData
                  if (!auth.currentUser) {
                    console.log('‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                    clearTimeout(loadTimeout);
                    return;
                  }

                  console.log('üîÑ –ù–∞—á–∞–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏...');
                  await updateSession(user.uid);
                  console.log('‚úÖ –°–µ—Å—Å–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞');

                  // –ü–†–û–í–ï–†–ö–ê: –ú–æ–∂–µ—Ç –±—ã—Ç—å signOut –ø—Ä–æ–∏–∑–æ—à–µ–ª –≤–æ –≤—Ä–µ–º—è updateSession
                  if (!auth.currentUser) {
                    console.log('‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª –≤–æ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏');
                    clearTimeout(loadTimeout);
                    return;
                  }

                  clearTimeout(loadTimeout);
                  console.log('‚úÖ Load timeout –æ—Ç–º–µ–Ω–µ–Ω');

                  // –û–¢–ö–õ–Æ–ß–ï–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
                  // –¢–µ–ø–µ—Ä—å –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 2FA
                  /*
                  if (isCheckingDevice) {
                    console.log('‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...');
                    const maxWait = 50;
                    let waitCount = 0;
                    while (isCheckingDevice && waitCount < maxWait) {
                      await new Promise(resolve => setTimeout(resolve, 100));
                      waitCount++;
                    }
                    if (isCheckingDevice || !auth.currentUser) {
                      console.log('üö´ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª');
                      setUser(null);
                      setGameState('auth');
                      return;
                    }
                  }
                  */

                  // –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å—ë –µ—â–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                  if (!auth.currentUser || !user || user.uid !== auth.currentUser.uid) {
                    console.log('üö´ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                    setUser(null);
                    setGameState('auth');
                    return;
                  }

                  // –£–ë–†–ê–ù–ê –¥–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞!
                  // handleLogin —É–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–ª —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —á–µ—Ä–µ–∑ checkAndSwitchDevice
                  // –≠—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–∑—ã–≤–∞–ª–∞ –ª–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è "–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—Ö–æ–¥"
                  // –ø–æ—Ç–æ–º—É —á—Ç–æ updateSession –µ—â–µ –Ω–µ —É—Å–ø–µ–≤–∞–ª —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é

                  console.log('üéÆ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —ç–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã (setup)');
                  setGameState('setup');

                  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Å—Å–∏—é –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ (—á–∞—â–µ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—Ö–æ–¥–∞)
                  console.log('‚è∞ –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ (–∫–∞–∂–¥—ã–µ 10 —Å–µ–∫)');
                  const sessionInterval = setInterval(() => {
                    if (auth.currentUser) {
                      updateSession(auth.currentUser.uid);
                    }
                  }, 10000);

                  // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
                  return () => clearInterval(sessionInterval);
                } else {
                  console.log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω (user = null)');
                  setUser(null);
                  setGameState('auth');
                }
              } catch (error) {
                console.error('Error in auth state changed:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message, 'error', 6000);
              } finally {
                setLoading(false);
                setLoadingStatus('');
              }
            });

            return () => {
              clearTimeout(loadingFallbackTimer);
              unsubscribe();
            };
          }, []);

          const loadUserData = async (userObj) => {
            try {
              const userId = userObj.uid;
              const userEmail = userObj.email;

              console.log('üîç Loading user data for:', userId, userEmail);
              setLoadingStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...'); // –ù–û–í–û–ï: –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

              // –ù–û–í–û–ï: –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –∫—ç—à–∞
              const cachedData = getCachedUserData(userId);
              if (cachedData) {
                console.log('‚úÖ Loaded from cache:', cachedData);
                setHasLicense(cachedData.hasLicense || false);
                setLoadingStatus('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö...');
              }

              const doc = await db.collection('users').doc(userId).get();
              if (doc.exists) {
                const data = doc.data();

                console.log('üìÑ Existing user document:', { hasLicense: data.hasLicense, email: data.email });

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞
                if (data.blocked) {
                  showNotification('üö´ –í–ê–® –ê–ö–ö–ê–£–ù–¢ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù\n\n–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.', 'error', 8000);
                  await auth.signOut();
                  setGameState('auth');
                  setLoadingStatus('');
                  return;
                }

                const licenseStatus = data.hasLicense || false;
                console.log('‚úÖ Setting hasLicense to:', licenseStatus);
                setHasLicense(licenseStatus);

                // –ù–û–í–û–ï: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                cacheUserData(userId, { hasLicense: licenseStatus, email: data.email });
              } else {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                console.log('üìù Creating new user document with hasLicense: false');
                setLoadingStatus('–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è...');

                await db.collection('users').doc(userId).set({
                  hasLicense: false,
                  blocked: false,  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
                  email: userEmail,  // –ò—Å–ø–æ–ª—å–∑—É–µ–º email –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞, –Ω–µ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ state
                  activatedCodes: [],  // –ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤
                  createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                console.log('‚úÖ New user created, setting hasLicense to: false');
                setHasLicense(false);

                // –ù–û–í–û–ï: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                cacheUserData(userId, { hasLicense: false, email: userEmail });
              }

              setLoadingStatus(''); // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ç—É—Å
            } catch (error) {
              console.error('‚ùå Error loading user data:', error);
              showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error', 6000);
              setLoadingStatus('');
            }
          };

          const handleRegister = async () => {
            try {
              setLoading(true);
              setLoadingStatus('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞...');

              const userCredential = await auth.createUserWithEmailAndPassword(email, password);

              // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–∏—Å—å–º–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email
              setLoadingStatus('–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å—å–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...');
              await userCredential.user.sendEmailVerification();

              setLoadingStatus('');
              setLoading(false);
              showNotification('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!\n\nüìß –ù–∞ –≤–∞—à—É –ø–æ—á—Ç—É ' + email + ' –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–∏—Å—å–º–æ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º.\n\n–í—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É —Å–µ–π—á–∞—Å, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å email.\n\nüí° –õ–æ–≥–∏–Ω: ' + email, 'success', 10000);
            } catch (error) {
              console.error('‚ùå Registration error:', error);
              setLoadingStatus('');
              setLoading(false);

              // –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –Ω–∞ —Ä—É—Å—Å–∫–æ–º
              let errorMessage = '‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
              if (error.code === 'auth/email-already-in-use') {
                errorMessage = '‚ùå –≠–¢–û–¢ EMAIL –£–ñ–ï –ó–ê–ù–Ø–¢\n\n–ê–∫–∫–∞—É–Ω—Ç —Å email "' + email + '" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.\n\nüí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n‚Ä¢ –í–æ–π—Ç–∏ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∞–∫–∫–∞—É–Ω—Ç\n‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π email\n‚Ä¢ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å –µ—Å–ª–∏ –∑–∞–±—ã–ª–∏';
              } else if (error.code === 'auth/invalid-email') {
                errorMessage = '‚ùå –ù–ï–í–ï–†–ù–´–ô EMAIL\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å.\n\n–ü—Ä–∏–º–µ—Ä: user@example.com';
              } else if (error.code === 'auth/weak-password') {
                errorMessage = '‚ùå –°–õ–ê–ë–´–ô –ü–ê–†–û–õ–¨\n\n–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤.\n\nüí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:\n‚Ä¢ –ë—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã\n‚Ä¢ –ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
              } else if (error.code === 'auth/operation-not-allowed') {
                errorMessage = '‚ùå –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –û–¢–ö–õ–Æ–ß–ï–ù–ê\n\n–°–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.';
              } else {
                errorMessage = '‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:\n\n' + error.message;
              }

              showNotification(errorMessage, 'error', 8000);
            }
          };

          const handleLogin = async () => {
            const startTime = Date.now();
            console.log('üîë ========================================');
            console.log('üîë –ù–ê–ß–ê–õ–û –í–•–û–î–ê –¥–ª—è:', email);
            console.log('üîë ========================================');

            try {
              setLoading(true);
              setLoadingStatus('–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç...');

              // –®–ê–ì 1: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Firebase
              const authStart = Date.now();
              console.log('üîê –®–ê–ì 1: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Firebase...');
              const userCredential = await auth.signInWithEmailAndPassword(email, password);
              const userId = userCredential.user.uid;
              const userEmail = userCredential.user.email;
              const authTime = ((Date.now() - authStart) / 1000).toFixed(1);
              console.log('‚úÖ Firebase –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞ –∑–∞', authTime, '—Å–µ–∫, userId:', userId);

              // –®–ê–ì 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ 2FA –∫–æ–¥–∞
              setLoadingStatus('–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...');
              const twoFAStart = Date.now();
              console.log('üìß –®–ê–ì 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ 2FA –∫–æ–¥–∞...');

              const code = generate2FACode();
              setGenerated2FACode(code); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
              console.log('‚úÖ –ö–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω:', code);

              await save2FACode(userId, code);
              console.log('‚úÖ –ö–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Firestore');

              await send2FAEmail(userEmail, code);
              console.log('‚úÖ –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ email');

              const twoFATime = ((Date.now() - twoFAStart) / 1000).toFixed(1);
              console.log('‚úÖ 2FA –∫–æ–¥ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –∑–∞', twoFATime, '—Å–µ–∫');

              // –®–ê–ì 3: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤–≤–æ–¥–∞ 2FA –∫–æ–¥–∞
              console.log('üîê –®–ê–ì 3: –û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞ 2FA –∫–æ–¥–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
              setUserCredentialTemp(userCredential); // –°–æ—Ö—Ä–∞–Ω—è–µ–º credentials
              await auth.signOut(); // –í—Ä–µ–º–µ–Ω–Ω–æ –≤—ã—Ö–æ–¥–∏–º –¥–æ –≤–≤–æ–¥–∞ 2FA
              setLoading(false);
              setLoadingStatus('');
              setPending2FA(true); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É 2FA

              const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);
              console.log('üìä –í–†–ï–ú–Ø –î–û 2FA:', totalTime, '—Å–µ–∫—É–Ω–¥');
              console.log('üîë ========================================');

              // –¢–µ–ø–µ—Ä—å –∂–¥–µ–º –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–¥–µ—Ç –∫–æ–¥ –≤ —Ñ–æ—Ä–º–µ 2FA
              // –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –≤ handleConfirm2FA()
            } catch (error) {
              const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);
              console.error('‚ùå Login error –ø–æ—Å–ª–µ', totalTime, '—Å–µ–∫—É–Ω–¥:', error);
              setLoading(false);
              setLoadingStatus('');

              // –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –Ω–∞ —Ä—É—Å—Å–∫–æ–º
              let errorMessage = '‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
              if (error.code === 'auth/wrong-password') {
                errorMessage = '‚ùå –ù–ï–í–ï–†–ù–´–ô –ü–ê–†–û–õ–¨\n\n–ü–∞—Ä–æ–ª—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π.\n\nüí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ø–∞—Ä–æ–ª—è\n‚Ä¢ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å';
              } else if (error.code === 'auth/user-not-found') {
                errorMessage = '‚ùå –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ù–ï –ù–ê–ô–î–ï–ù\n\n–ê–∫–∫–∞—É–Ω—Ç —Å email "' + email + '" –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.\n\nüí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å email\n‚Ä¢ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç';
              } else if (error.code === 'auth/invalid-email') {
                errorMessage = '‚ùå –ù–ï–í–ï–†–ù–´–ô EMAIL\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å.';
              } else if (error.code === 'auth/user-disabled') {
                errorMessage = '‚ùå –ê–ö–ö–ê–£–ù–¢ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù\n\n–≠—Ç–æ—Ç –∞–∫–∫–∞—É–Ω—Ç –±—ã–ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.\n\n–°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.';
              } else if (error.code === 'auth/too-many-requests') {
                errorMessage = '‚ö†Ô∏è –°–õ–ò–®–ö–û–ú –ú–ù–û–ì–û –ü–û–ü–´–¢–û–ö\n\n–î–æ—Å—Ç—É–ø –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏–∑-–∑–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞.\n\nüí° –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –∏–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞—Ä–æ–ª—å.';
              } else if (error.code === 'auth/network-request-failed') {
                errorMessage = 'üåê –û–®–ò–ë–ö–ê –°–ï–¢–ò\n\n–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É.\n\nüí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.';
              } else {
                errorMessage = '‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:\n\n' + error.message;
              }

              showNotification(errorMessage, 'error', 8000);
            }
          };

          // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ 2FA –∫–æ–¥–∞
          const handleConfirm2FA = async () => {
            console.log('üîê –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ 2FA –∫–æ–¥–∞...');

            if (!twoFactorCode) {
              showNotification('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è', 'warning', 5000);
              return;
            }

            if (!userCredentialTemp) {
              showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Å—Å–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ —Å–Ω–æ–≤–∞.', 'error', 6000);
              setPending2FA(false);
              return;
            }

            try {
              setLoading(true);
              setLoadingStatus('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞...');

              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥
              const result = await verify2FACode(userCredentialTemp.user.uid, twoFactorCode);

              if (!result.success) {
                setLoading(false);
                setLoadingStatus('');
                showNotification('‚ùå ' + result.message, 'error', 6000);
                return;
              }

              console.log('‚úÖ 2FA –∫–æ–¥ –≤–µ—Ä–Ω—ã–π! –ó–∞–≤–µ—Ä—à–∞–µ–º –≤—Ö–æ–¥...');

              // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Å—Å–∏—é Firebase
              setLoadingStatus('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—Ö–æ–¥–∞...');
              await auth.signInWithEmailAndPassword(email, password);

              // –£—Å–ø–µ—Ö! –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ 2FA
              setPending2FA(false);
              setTwoFactorCode('');
              setUserCredentialTemp(null);
              setGenerated2FACode('');

              showNotification('‚úÖ –í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω!\n\n–î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞.', 'success', 4000);

              console.log('üîë ========================================');
              console.log('‚úÖ –í–•–û–î –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û');
              console.log('üîë ========================================');

              // Firebase –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ onAuthStateChanged
            } catch (error) {
              console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è 2FA:', error);
              setLoading(false);
              setLoadingStatus('');
              showNotification('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error', 6000);
            }
          };

          // –û—Ç–º–µ–Ω–∞ 2FA
          const handleCancel2FA = () => {
            console.log('‚ùå 2FA –æ—Ç–º–µ–Ω–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
            setPending2FA(false);
            setTwoFactorCode('');
            setUserCredentialTemp(null);
            setGenerated2FACode('');
            showNotification('‚ÑπÔ∏è –í—Ö–æ–¥ –æ—Ç–º–µ–Ω–µ–Ω', 'info', 3000);
          };

          const handleLogout = async () => {
            try {
              // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–µ—Å—Å–∏—é
              if (user) {
                await db.collection('sessions').doc(user.uid).update({
                  isActive: false,
                  logoutAt: firebase.firestore.FieldValue.serverTimestamp()
                });
              }

              await auth.signOut();
              setGameState('auth');
            } catch (error) {
              console.error('Error signing out:', error);
            }
          };

          const handlePasswordReset = async () => {
            if (!email) {
              showNotification('‚ùå –í–≤–µ–¥–∏—Ç–µ email –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è', 'warning', 5000);
              return;
            }

            try {
              setLoadingStatus('–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å—å–º–∞...');
              await auth.sendPasswordResetEmail(email);
              setLoadingStatus('');
              showNotification('‚úÖ –ü–∏—Å—å–º–æ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ ' + email + '\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à—É –ø–æ—á—Ç—É (—Ç–∞–∫–∂–µ –ø–∞–ø–∫—É "–°–ø–∞–º")', 'success', 8000);
              setAuthMode('login');
            } catch (error) {
              setLoadingStatus('');
              showNotification('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error', 6000);
            }
          };

          const toggleOperation = (op) => {
            const newOps = { ...operations, [op]: !operations[op] };
            const hasAtLeastOne = Object.values(newOps).some(v => v);
            if (hasAtLeastOne) {
              setOperations(newOps);
            }
          };

          const activateCode = async () => {
            if (!user) {
              showNotification('‚ùå –û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω', 'error', 5000);
              return;
            }

            const code = activationCode.toUpperCase().trim();

            if (!code) {
              showNotification('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏', 'warning', 5000);
              return;
            }

            try {
              setLoadingStatus('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞...');

              // 1. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
              const userDoc = await db.collection('users').doc(user.uid).get();
              const userData = userDoc.data();

              // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —ç—Ç–æ—Ç –∫–æ–¥
              if (userData.activatedCodes && userData.activatedCodes.includes(code)) {
                setLoadingStatus('');
                showNotification('‚ùå –í—ã —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –∫–æ–¥ —Ä–∞–Ω–µ–µ!', 'warning', 6000);
                return;
              }

              // 3. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–¥–∞
              const codeDoc = await db.collection('codes').doc(code).get();

              if (!codeDoc.exists) {
                setLoadingStatus('');
                showNotification('‚ùå –ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞.', 'error', 6000);
                return;
              }

              const codeData = codeDoc.data();

              // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ª–∏ –∫–æ–¥ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
              if (codeData.used) {
                setLoadingStatus('');
                if (codeData.usedBy === user.uid) {
                  showNotification('‚ùå –í—ã —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –∫–æ–¥!', 'warning', 6000);
                } else {
                  showNotification('‚ùå –≠—Ç–æ—Ç –∫–æ–¥ —É–∂–µ –±—ã–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º!', 'error', 6000);
                }
                return;
              }

              // 5. –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø: –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
              await db.runTransaction(async (transaction) => {
                // –ü–æ–º–µ—á–∞–µ–º –∫–æ–¥ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π
                transaction.update(db.collection('codes').doc(code), {
                  used: true,
                  usedBy: user.uid,
                  usedByEmail: user.email,
                  usedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –¥–∞–µ–º –±–µ—Å—Å—Ä–æ—á–Ω—É—é –ª–∏—Ü–µ–Ω–∑–∏—é
                const activatedCodes = userData.activatedCodes || [];
                activatedCodes.push(code);

                transaction.update(db.collection('users').doc(user.uid), {
                  hasLicense: true,
                  activatedCodes: activatedCodes,
                  lastActivation: firebase.firestore.FieldValue.serverTimestamp()
                });
              });

              // 6. –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
              setLoadingStatus('–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏...');
              setHasLicense(true);
              setActivationCode('');
              setShowActivation(false);

              // –ù–û–í–û–ï: –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
              cacheUserData(user.uid, { hasLicense: true, email: user.email });

              setLoadingStatus('');
              showNotification(`‚úÖ –ö–æ–¥ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!\n\nüéâ –ë–µ—Å—Å—Ä–æ—á–Ω–∞—è –ª–∏—Ü–µ–Ω–∑–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!\nüîë –ö–æ–¥: ${code}\n\n‚ú® –¢–µ–ø–µ—Ä—å —É –≤–∞—Å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –∏–≥—Ä–µ –Ω–∞–≤—Å–µ–≥–¥–∞!`, 'success', 10000);

            } catch (error) {
              console.error('Error activating code:', error);
              setLoadingStatus('');

              // –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
              if (error.code === 'permission-denied') {
                showNotification('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.', 'error', 6000);
              } else if (error.code === 'unavailable') {
                showNotification('‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'error', 6000);
              } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.\n\n' + error.message, 'error', 8000);
              }
            }
          };

          const speak = (text) => {
            if (!soundEnabled) return;
            try {
              const utterance = new SpeechSynthesisUtterance(text);
              utterance.lang = 'ru-RU';
              utterance.rate = 0.9;
              utterance.pitch = 1.2;
              utterance.volume = 1;
              window.speechSynthesis.cancel();
              window.speechSynthesis.speak(utterance);
            } catch (e) {
              console.log('Speech not supported');
            }
          };

          const playSound = (frequency, duration, type = 'sine') => {
            if (!soundEnabled || !audioContextRef.current) return;
            try {
              const ctx = audioContextRef.current;
              const oscillator = ctx.createOscillator();
              const gainNode = ctx.createGain();
              oscillator.connect(gainNode);
              gainNode.connect(ctx.destination);
              oscillator.frequency.value = frequency;
              oscillator.type = type;
              gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
              oscillator.start(ctx.currentTime);
              oscillator.stop(ctx.currentTime + duration);
            } catch (e) {
              console.log('Sound error');
            }
          };

          const playCorrectSound = () => {
            playSound(523.25, 0.1);
            setTimeout(() => playSound(659.25, 0.1), 100);
            setTimeout(() => playSound(783.99, 0.2), 200);
          };

          const playWrongSound = () => playSound(200, 0.3, 'sawtooth');
          
          const playStreakSound = () => {
            playSound(880, 0.15);
            setTimeout(() => playSound(1046.5, 0.2), 150);
          };

          const startGame = async () => {
            if (!hasLicense) {
              showNotification('‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∏–≥—Ä–µ!\n\nüîë –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–µ—Å—Å—Ä–æ—á–Ω–æ–π –ª–∏—Ü–µ–Ω–∑–∏–∏.', 'warning', 8000);
              setShowActivation(true);
              return;
            }

            setGameState('playing');
            setScore(0);
            setCurrentRound(0);
            setStreak(0);
            setBestStreak(0);
            setGameHistory([]);
            generateQuestion();
          };

          const generateQuestion = (incrementRound = false) => {
            // –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—É–Ω–¥ –ü–ï–†–ï–î –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –≤–æ–ø—Ä–æ—Å–∞
            if (incrementRound) {
              setCurrentRound(prev => prev + 1);
            }

            const activeOps = [];
            if (operations.multiply) activeOps.push('√ó');
            if (operations.divide) activeOps.push('√∑');
            if (operations.add) activeOps.push('+');
            if (operations.subtract) activeOps.push('‚àí');

            const op = activeOps[Math.floor(Math.random() * activeOps.length)];
            setCurrentOperation(op);

            let n1, n2;
            if (op === '√∑') {
              n2 = Math.floor(Math.random() * 9) + 2;
              const result = Math.floor(Math.random() * 10) + 1;
              n1 = n2 * result;
            } else if (op === '‚àí') {
              n1 = Math.floor(Math.random() * 10) + 11;
              n2 = Math.floor(Math.random() * 10) + 1;
              if (n2 >= n1) n2 = n1 - 1;
            } else {
              n1 = Math.floor(Math.random() * 10) + 1;
              n2 = Math.floor(Math.random() * 10) + 1;
            }

            setNum1(n1);
            setNum2(n2);
            setAnswer('');
            setMessage('');
            setAttempts(2);
            setLives(2);
          };

          const calculateCorrectAnswer = () => {
            switch(currentOperation) {
              case '√ó': return num1 * num2;
              case '√∑': return num1 / num2;
              case '+': return num1 + num2;
              case '‚àí': return num1 - num2;
              default: return 0;
            }
          };

          const showResults = () => {
            setGameState('results');
          };

          const checkAnswer = () => {
            const userAnswer = parseInt(answer);
            const correctAnswer = calculateCorrectAnswer();
            const isCorrect = userAnswer === correctAnswer;
            
            if (isCorrect) {
              playCorrectSound();
              speak('–ü—Ä–∞–≤–∏–ª—å–Ω–æ! –¢—ã –º–æ–ª–æ–¥–µ—Ü!');
              setScore(score + 1);
              setStreak(streak + 1);
              if (streak + 1 > bestStreak) setBestStreak(streak + 1);
              if ((streak + 1) % 5 === 0) setTimeout(playStreakSound, 300);
              setMessage('üéâ –ü—Ä–∞–≤–∏–ª—å–Ω–æ! –¢—ã –º–æ–ª–æ–¥–µ—Ü!');
              
              const existingWrong = gameHistory.find(h => h.question === `${num1} ${currentOperation} ${num2}` && !h.isCorrect);
              setGameHistory([...gameHistory.filter(h => !(h.question === `${num1} ${currentOperation} ${num2}` && !h.isCorrect)), {
                question: `${num1} ${currentOperation} ${num2}`,
                userAnswer,
                correctAnswer,
                isCorrect: true,
                wrongAnswers: existingWrong?.wrongAnswers || []
              }]);

              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω –ª–∏ —Ä–∞—É–Ω–¥
              const nextRound = currentRound + 1;
              if (nextRound >= totalRounds) {
                setTimeout(() => showResults(), 2000);
              } else {
                // –ü–µ—Ä–µ–¥–∞–µ–º —Ñ–ª–∞–≥ —á—Ç–æ –Ω—É–∂–Ω–æ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—É–Ω–¥
                setTimeout(() => generateQuestion(true), 2000);
              }
            } else {
              if (attempts > 0) {
                playWrongSound();
                speak('–ü–æ–¥—É–º–∞–π –µ—â—ë');
                setAttempts(attempts - 1);
                setLives(lives - 1);
                setMessage('ü§î –ü–æ–¥—É–º–∞–π –µ—â—ë');
                
                const existingEntry = gameHistory.find(h => h.question === `${num1} ${currentOperation} ${num2}` && !h.isCorrect);
                const wrongAnswers = existingEntry?.wrongAnswers ? [...existingEntry.wrongAnswers, userAnswer] : [userAnswer];
                setGameHistory([...gameHistory.filter(h => !(h.question === `${num1} ${currentOperation} ${num2}` && !h.isCorrect)), {
                  question: `${num1} ${currentOperation} ${num2}`,
                  userAnswer,
                  correctAnswer,
                  isCorrect: false,
                  wrongAnswers
                }]);
                setAnswer('');
              } else {
                playWrongSound();
                speak(`–ù–µ–≤–µ—Ä–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç ${correctAnswer}`);
                setStreak(0);
                setMessage(`‚ùå –ù–µ–≤–µ—Ä–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${correctAnswer}`);
                
                const existingEntry = gameHistory.find(h => h.question === `${num1} ${currentOperation} ${num2}` && !h.isCorrect);
                const wrongAnswers = existingEntry?.wrongAnswers ? [...existingEntry.wrongAnswers, userAnswer] : [userAnswer];
                setGameHistory([...gameHistory.filter(h => !(h.question === `${num1} ${currentOperation} ${num2}` && !h.isCorrect)), {
                  question: `${num1} ${currentOperation} ${num2}`,
                  userAnswer,
                  correctAnswer,
                  isCorrect: false,
                  wrongAnswers
                }]);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω –ª–∏ —Ä–∞—É–Ω–¥
                const nextRound = currentRound + 1;
                if (nextRound >= totalRounds) {
                  setTimeout(() => showResults(), 2500);
                } else {
                  // –ü–µ—Ä–µ–¥–∞–µ–º —Ñ–ª–∞–≥ —á—Ç–æ –Ω—É–∂–Ω–æ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—É–Ω–¥
                  setTimeout(() => generateQuestion(true), 2500);
                }
              }
            }
          };

          const handleKeyPress = (e) => {
            if (e.key === 'Enter' && answer !== '') checkAnswer();
          };

          const handleAuthKeyPress = (e) => {
            if (e.key === 'Enter') {
              authMode === 'login' ? handleLogin() : handleRegister();
            }
          };

          const handleActivationKeyPress = (e) => {
            if (e.key === 'Enter' && activationCode !== '') activateCode();
          };

          const resetGame = () => {
            setGameState('setup');
            setTotalRounds(10);
          };

          const percentage = totalRounds > 0 ? Math.round((score / totalRounds) * 100) : 0;

          const mathBg = {
            backgroundImage: `url("data:image/svg+xml,%3Csvg width='60' height='60' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext x='5' y='20' font-size='20' fill='%23e0e7ff' opacity='0.3'%3E+%3C/text%3E%3Ctext x='35' y='45' font-size='20' fill='%23ddd6fe' opacity='0.3'%3E√ó%3C/text%3E%3Ctext x='15' y='50' font-size='18' fill='%23fce7f3' opacity='0.3'%3E=%3C/text%3E%3C/svg%3E")`,
            backgroundSize: '60px 60px'
          };

          // –ù–û–í–û–ï: Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
          const ToastNotifications = () => (
            <div className="fixed top-4 right-4 z-50 space-y-2" style={{ maxWidth: '400px' }}>
              {notifications.map(notif => {
                const bgColor = {
                  success: 'bg-green-500',
                  error: 'bg-red-500',
                  warning: 'bg-orange-500',
                  info: 'bg-blue-500'
                }[notif.type] || 'bg-gray-500';

                return (
                  <div
                    key={notif.id}
                    className={`${bgColor} text-white p-4 rounded-lg shadow-2xl border-2 border-white animate-slide-in`}
                    style={{
                      animation: 'slideIn 0.3s ease-out',
                      whiteSpace: 'pre-line',
                      wordWrap: 'break-word'
                    }}
                  >
                    <div className="font-bold text-sm">{notif.message}</div>
                  </div>
                );
              })}
              <style jsx>{`
                @keyframes slideIn {
                  from {
                    transform: translateX(100%);
                    opacity: 0;
                  }
                  to {
                    transform: translateX(0);
                    opacity: 1;
                  }
                }
              `}</style>
            </div>
          );

          if (loading) {
            return (
              <>
                <ToastNotifications />
                <div className="min-h-screen bg-gradient-to-br from-purple-200 via-pink-200 to-blue-200 flex items-center justify-center">
                  <div className="text-center">
                    <div className="text-6xl mb-4 animate-bounce">‚è≥</div>
                    {loadingStatus && (
                      <div className="text-xl font-bold text-purple-700 bg-white px-6 py-3 rounded-full shadow-lg">
                        {loadingStatus}
                      </div>
                    )}
                  </div>
                </div>
              </>
            );
          }

          if (gameState === 'auth') {
            return (
              <>
                <ToastNotifications />
                <div className="min-h-screen bg-gradient-to-br from-purple-200 via-pink-200 to-blue-200 flex items-center justify-center p-4" style={mathBg}>
                <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full border-4 border-purple-400">
                  <div className="text-center mb-8">
                    <div className="text-6xl mb-4">{authMode === 'reset' ? 'üîë' : 'üéì'}</div>
                    <h1 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 mb-2">
                      {authMode === 'login' ? '–í—Ö–æ–¥' : authMode === 'register' ? '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è' : '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è'}
                    </h1>
                    <p className="text-purple-600 font-bold">–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–≥—Ä–∞</p>
                  </div>

                  <div className="mb-4">
                    <input
                      type="email"
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      onKeyPress={handleAuthKeyPress}
                      placeholder="Email"
                      className="w-full text-lg border-2 border-purple-300 rounded-xl p-3 focus:outline-none focus:border-purple-500"
                    />
                  </div>

                  {authMode !== 'reset' && (
                    <div className="mb-6">
                      <input
                        type="password"
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        onKeyPress={handleAuthKeyPress}
                        placeholder="–ü–∞—Ä–æ–ª—å"
                        className="w-full text-lg border-2 border-purple-300 rounded-xl p-3 focus:outline-none focus:border-purple-500"
                      />
                    </div>
                  )}

                  <button
                    onClick={authMode === 'login' ? handleLogin : authMode === 'register' ? handleRegister : handlePasswordReset}
                    className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xl font-black py-4 rounded-xl hover:from-purple-600 hover:to-pink-600 transition-all shadow-lg mb-4"
                  >
                    {authMode === 'login' ? '–í–û–ô–¢–ò' : authMode === 'register' ? '–ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–¢–¨–°–Ø' : '–û–¢–ü–†–ê–í–ò–¢–¨ –ü–ò–°–¨–ú–û'}
                  </button>

                  {authMode === 'login' && (
                    <button
                      onClick={() => setAuthMode('reset')}
                      className="w-full text-sm text-gray-500 hover:text-purple-600 font-semibold mb-2"
                    >
                      üîë –ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?
                    </button>
                  )}

                  <button
                    onClick={() => setAuthMode(authMode === 'login' ? 'register' : 'login')}
                    className="w-full text-purple-600 font-semibold"
                  >
                    {authMode === 'login' ? '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å' : '–ï—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π–¥–∏—Ç–µ'}
                  </button>
                </div>
              </div>
              </>
            );
          }

          if (gameState === 'setup') {
            return (
              <>
                <ToastNotifications />
                <div className="min-h-screen bg-gradient-to-br from-purple-200 via-pink-200 to-blue-200 flex items-center justify-center p-4" style={mathBg}>
                <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full border-4 border-purple-400 relative overflow-hidden">
                  <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-purple-400 via-pink-400 to-blue-400"></div>
                  
                  <div className="mb-6">
                    <div className="flex justify-between items-center mb-2">
                      <div className={`text-white px-4 py-2 rounded-full font-bold shadow-lg ${hasLicense ? 'bg-green-500' : 'bg-gray-500'}`}>
                        {hasLicense ? '‚úÖ –õ–∏—Ü–µ–Ω–∑–∏—è –∞–∫—Ç–∏–≤–Ω–∞' : 'üîí –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞'}
                      </div>
                      <button
                        onClick={handleLogout}
                        className="bg-red-500 text-white px-4 py-2 rounded-full font-bold shadow-lg hover:bg-red-600"
                      >
                        üö™ –í—ã–π—Ç–∏
                      </button>
                    </div>
                    <div className="text-xs text-gray-500 text-right opacity-70">
                      {user?.email}
                    </div>
                  </div>

                  {showActivation && (
                    <div className="mb-6 bg-yellow-50 border-2 border-yellow-400 rounded-xl p-4">
                      <p className="font-bold text-yellow-800 mb-2">üîë –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ª–∏—Ü–µ–Ω–∑–∏—é:</p>
                      <input
                        type="text"
                        value={activationCode}
                        onChange={(e) => setActivationCode(e.target.value.toUpperCase())}
                        onKeyPress={handleActivationKeyPress}
                        placeholder="XXXX-XXXX"
                        maxLength="9"
                        className="w-full text-xl text-center border-2 border-yellow-400 rounded-xl p-2 mb-2 font-bold uppercase"
                      />
                      <button
                        onClick={activateCode}
                        className="w-full bg-yellow-500 text-white font-bold py-2 rounded-xl hover:bg-yellow-600"
                      >
                        –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
                      </button>
                      <button
                        onClick={() => setShowActivation(false)}
                        className="w-full mt-2 text-gray-600 font-semibold"
                      >
                        –û—Ç–º–µ–Ω–∞
                      </button>
                    </div>
                  )}
                  
                  <div className="text-center mb-8">
                    <div className="text-6xl mb-4">üî¢</div>
                    <h1 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 mb-2">
                      –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞
                    </h1>
                    <p className="text-purple-600 font-bold text-lg">–í—ã–±–µ—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏!</p>
                  </div>

                  <div className="mb-6 bg-gradient-to-r from-purple-100 to-pink-100 p-6 rounded-2xl border-2 border-purple-300">
                    <label className="block text-purple-800 font-bold mb-3 text-center text-lg">
                      üéØ –ö–∞–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏?
                    </label>
                    <div className="grid grid-cols-2 gap-3 mb-4">
                      <button
                        onClick={() => toggleOperation('multiply')}
                        className={`py-4 rounded-xl font-black text-xl transition-all transform hover:scale-105 ${
                          operations.multiply 
                            ? 'bg-gradient-to-br from-purple-500 to-purple-600 text-white shadow-lg' 
                            : 'bg-white text-purple-500 border-2 border-purple-300'
                        }`}
                      >
                        √ó
                      </button>
                      <button
                        onClick={() => toggleOperation('divide')}
                        className={`py-4 rounded-xl font-black text-xl transition-all transform hover:scale-105 ${
                          operations.divide 
                            ? 'bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-lg' 
                            : 'bg-white text-blue-500 border-2 border-blue-300'
                        }`}
                      >
                        √∑
                      </button>
                      <button
                        onClick={() => toggleOperation('add')}
                        className={`py-4 rounded-xl font-black text-xl transition-all transform hover:scale-105 ${
                          operations.add 
                            ? 'bg-gradient-to-br from-green-500 to-green-600 text-white shadow-lg' 
                            : 'bg-white text-green-500 border-2 border-green-300'
                        }`}
                      >
                        +
                      </button>
                      <button
                        onClick={() => toggleOperation('subtract')}
                        className={`py-4 rounded-xl font-black text-xl transition-all transform hover:scale-105 ${
                          operations.subtract 
                            ? 'bg-gradient-to-br from-orange-500 to-orange-600 text-white shadow-lg' 
                            : 'bg-white text-orange-500 border-2 border-orange-300'
                        }`}
                      >
                        ‚àí
                      </button>
                    </div>
                  </div>

                  <div className="mb-6 bg-gradient-to-r from-purple-100 to-pink-100 p-6 rounded-2xl border-2 border-purple-300">
                    <label className="block text-purple-800 font-bold mb-3 text-center text-lg">
                      üìù –°–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–æ–≤?
                    </label>
                    <div className="text-center mb-4">
                      <span className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600">
                        {totalRounds}
                      </span>
                    </div>
                    <input
                      type="range"
                      value={totalRounds}
                      onChange={(e) => setTotalRounds(parseInt(e.target.value))}
                      min="5"
                      max="50"
                      step="5"
                      className="w-full h-4 rounded-full appearance-none cursor-pointer"
                      style={{
                        background: `linear-gradient(to right, #a855f7 0%, #ec4899 ${(totalRounds - 5) / 45 * 100}%, #e9d5ff ${(totalRounds - 5) / 45 * 100}%, #fce7f3 100%)`
                      }}
                    />
                    <div className="flex justify-between text-sm text-purple-600 mt-2 font-semibold">
                      <span>5</span>
                      <span>25</span>
                      <span>50</span>
                    </div>
                  </div>

                  <button
                    onClick={startGame}
                    className="w-full bg-gradient-to-r from-purple-500 via-pink-500 to-purple-500 text-white text-2xl font-black py-5 rounded-2xl hover:from-purple-600 hover:via-pink-600 hover:to-purple-600 transition-all transform hover:scale-105 flex items-center justify-center gap-3 shadow-lg mb-4"
                  >
                    ‚ñ∂ –ü–û–ï–•–ê–õ–ò!
                  </button>

                  {!hasLicense && (
                    <button
                      onClick={() => setShowActivation(!showActivation)}
                      className="w-full bg-yellow-500 text-white font-bold py-3 rounded-xl hover:bg-yellow-600"
                    >
                      üîë –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ª–∏—Ü–µ–Ω–∑–∏—é
                    </button>
                  )}
                </div>
              </div>
              </>
            );
          }

          if (gameState === 'results') {
            const grade = percentage >= 90 ? 'üèÜ' : percentage >= 70 ? '‚≠ê' : percentage >= 50 ? 'üëç' : 'üí™';

            return (
              <>
                <ToastNotifications />
                <div className="min-h-screen bg-gradient-to-br from-purple-200 via-pink-200 to-blue-200 flex items-center justify-center p-4" style={mathBg}>
                <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full border-4 border-purple-400 relative overflow-hidden">
                  <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-purple-400 via-pink-400 to-blue-400"></div>

                  <div className="text-center mb-6">
                    <div className="text-8xl mb-4">{grade}</div>
                    <h1 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 mb-2">
                      –ò–≥—Ä–∞ –ó–∞–≤–µ—Ä—à–µ–Ω–∞!
                    </h1>
                    <p className="text-2xl font-bold text-purple-600">
                      {percentage >= 90 ? '–û—Ç–ª–∏—á–Ω–æ!' : percentage >= 70 ? '–•–æ—Ä–æ—à–æ!' : percentage >= 50 ? '–ù–µ–ø–ª–æ—Ö–æ!' : '–ü—Ä–æ–¥–æ–ª–∂–∞–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è!'}
                    </p>
                  </div>

                  <div className="grid grid-cols-3 gap-4 mb-6">
                    <div className="bg-gradient-to-br from-green-400 to-emerald-500 rounded-2xl p-4 text-center shadow-lg">
                      <div className="text-4xl font-black text-white">{score}</div>
                      <div className="text-sm font-bold text-white">‚úì –ü—Ä–∞–≤–∏–ª—å–Ω–æ</div>
                    </div>
                    <div className="bg-gradient-to-br from-blue-400 to-indigo-500 rounded-2xl p-4 text-center shadow-lg">
                      <div className="text-4xl font-black text-white">{totalRounds}</div>
                        <div className="text-sm font-bold text-white">üìù –í—Å–µ–≥–æ</div>
                    </div>
                    <div className="bg-gradient-to-br from-yellow-400 to-orange-500 rounded-2xl p-4 text-center shadow-lg">
                      <div className="text-4xl font-black text-white">{percentage}%</div>
                      <div className="text-sm font-bold text-white">üìä –ü—Ä–æ—Ü–µ–Ω—Ç</div>
                    </div>
                  </div>
                    <div className="bg-gradient-to-r from-purple-100 to-pink-100 rounded-2xl p-4 mb-6 border-2 border-purple-300">
                <div className="text-center text-xl font-black text-purple-700">
                  ‚≠ê –õ—É—á—à–∞—è —Å–µ—Ä–∏—è: {bestStreak} –ø–æ–¥—Ä—è–¥! ‚≠ê
                </div>
              </div>

              <div className="mb-6 max-h-80 overflow-y-auto bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl p-4 border-2 border-purple-300">
                <h3 className="font-black text-purple-700 mb-3 text-center text-xl">
                  ‚ú® –¢–≤–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: ‚ú®
                </h3>
                <div className="space-y-2">
                  {gameHistory.map((item, index) => (
                    <div key={index} className={`flex justify-between items-center py-3 px-4 rounded-xl shadow-md font-bold text-lg ${
                      item.isCorrect ? 'bg-gradient-to-r from-green-100 to-emerald-100 border-2 border-green-400' : 'bg-gradient-to-r from-red-100 to-rose-100 border-2 border-red-400'
                    }`}>
                      <span className="text-purple-900">
                        {index + 1}. {item.question} = {item.correctAnswer}
                      </span>
                      <div className="flex items-center gap-2">
                        {!item.isCorrect && item.wrongAnswers && item.wrongAnswers.length > 0 && (
                          <span className="text-sm text-red-600 bg-red-50 px-2 py-1 rounded border border-red-300">
                            –ü–æ–ø—ã—Ç–∫–∏: {item.wrongAnswers.join(', ')}
                          </span>
                        )}
                        <span className={`text-2xl ${item.isCorrect ? 'text-green-600' : 'text-red-600'}`}>
                          {item.isCorrect ? '‚úì' : '‚úó'}
                        </span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              <button
                onClick={resetGame}
                className="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-purple-500 via-pink-500 to-purple-500 text-white font-black py-5 text-xl rounded-2xl hover:from-purple-600 hover:via-pink-600 hover:to-purple-600 transition-all shadow-lg"
              >
                üîÑ –ò–ì–†–ê–¢–¨ –°–ù–û–í–ê!
              </button>
            </div>
          </div>
          </>
        );
      }

      return (
        <>
          <ToastNotifications />
          <div className="min-h-screen bg-gradient-to-br from-purple-200 via-pink-200 to-blue-200 flex items-center justify-center p-4" style={mathBg}>
          <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full border-4 border-purple-400 relative overflow-hidden">
            <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-purple-400 via-pink-400 to-blue-400"></div>

            <div className="text-xs text-gray-400 text-right mb-1 opacity-60">
              {user?.email}
            </div>

            <div className="text-center mb-6">
              <div className="flex items-center justify-between mb-2">
                <div className="flex-1"></div>
                <h1 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 flex-1">
                  üî¢ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ üî¢
                </h1>
                <button
                  onClick={() => setSoundEnabled(!soundEnabled)}
                  className="flex-1 flex justify-end text-3xl"
                  style={{background: 'none', border: 'none', cursor: 'pointer'}}
                >
                  {soundEnabled ? 'üîä' : 'üîá'}
                </button>
              </div>
              <p className="text-purple-600 font-bold text-lg">–ü—Ä–∏–º–µ—Ä {currentRound + 1} –∏–∑ {totalRounds}</p>
            </div>

            <div className="grid grid-cols-3 gap-3 mb-6">
              <div className="bg-gradient-to-br from-green-400 to-emerald-500 rounded-2xl p-3 text-center shadow-lg">
                <div className="text-2xl font-black text-white">{score}</div>
                <div className="text-xs font-bold text-white">‚úì –í–µ—Ä–Ω–æ</div>
              </div>
              <div className="bg-gradient-to-br from-blue-400 to-indigo-500 rounded-2xl p-3 text-center shadow-lg">
                <div className="text-2xl font-black text-white">{currentRound}</div>
                <div className="text-xs font-bold text-white">üìù –†–µ—à–µ–Ω–æ</div>
              </div>
              <div className="bg-gradient-to-br from-yellow-400 to-orange-500 rounded-2xl p-3 text-center shadow-lg">
                <div className="text-2xl font-black text-white">{percentage}%</div>
                <div className="text-xs font-bold text-white">üìä</div>
              </div>
            </div>

            <div className="flex items-center justify-center gap-2 mb-6 bg-gradient-to-r from-yellow-100 to-orange-100 p-3 rounded-2xl border-2 border-yellow-400 shadow-inner">
              <span className="text-2xl">‚≠ê</span>
              <span className="text-lg font-black text-orange-700">
                –°–µ—Ä–∏—è: {streak} üî•
              </span>
              {bestStreak > 0 && (
                <span className="text-sm font-bold text-orange-600 ml-2">
                  (–º–∞–∫—Å: {bestStreak})
                </span>
              )}
            </div>

            <div className="bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100 rounded-3xl p-6 mb-6 border-3 border-purple-300 shadow-xl">
              <div className="flex justify-center gap-3 mb-4">
                {[...Array(2)].map((_, i) => (
                  <span key={i} className="text-4xl">
                    {lives > i ? '‚ù§Ô∏è' : 'ü§ç'}
                  </span>
                ))}
              </div>
              
              <div className="text-center mb-6 bg-white p-4 rounded-2xl border-3 border-purple-300 shadow-inner">
                <div className="flex items-center justify-center gap-3 flex-wrap">
                  <span className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600">
                    {num1}
                  </span>
                  <span className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600">
                    {currentOperation}
                  </span>
                  <span className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600">
                    {num2}
                  </span>
                  <span className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600">
                    =
                  </span>
                  <input
                    type="text"
                    inputMode="numeric"
                    pattern="[0-9]*"
                    value={answer}
                    onChange={(e) => {
                      const value = e.target.value.replace(/[^0-9]/g, '');
                      setAnswer(value);
                    }}
                    onKeyPress={handleKeyPress}
                    className="w-24 text-5xl text-center border-4 border-purple-400 rounded-xl p-2 focus:outline-none focus:border-pink-500 font-black text-purple-700 bg-yellow-50 shadow-lg"
                    placeholder="?"
                    autoFocus
                  />
                </div>
              </div>

              <button
                onClick={checkAnswer}
                disabled={answer === ''}
                className="w-full bg-gradient-to-r from-purple-500 via-pink-500 to-purple-500 text-white text-xl font-black py-4 rounded-2xl hover:from-purple-600 hover:via-pink-600 hover:to-purple-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all transform hover:scale-105 shadow-lg"
              >
                –ü–†–û–í–ï–†–ò–¢–¨ ‚ú®
              </button>
            </div>

            {message && (
              <div className={`text-center text-xl font-black mb-4 p-4 rounded-2xl border-3 shadow-lg ${
                message.includes('–ü—Ä–∞–≤–∏–ª—å–Ω–æ') 
                  ? 'bg-gradient-to-r from-green-100 to-emerald-100 text-green-700 border-green-400' 
                  : message.includes('–ü–æ–¥—É–º–∞–π')
                  ? 'bg-gradient-to-r from-yellow-100 to-orange-100 text-yellow-700 border-yellow-400'
                  : 'bg-gradient-to-r from-red-100 to-rose-100 text-red-700 border-red-400'
              }`}>
                {message}
              </div>
            )}

            {score >= 5 && currentRound < totalRounds && (
              <div className="mt-6 text-center bg-gradient-to-r from-yellow-100 to-orange-100 p-4 rounded-2xl border-2 border-yellow-400 shadow-lg">
                <div className="text-4xl mb-2">üèÜ</div>
                <div className="text-yellow-800 font-black text-lg">
                  ‚≠ê –°—É–ø–µ—Ä! –¢—ã –æ—Ç–ª–∏—á–Ω–æ —Å–ø—Ä–∞–≤–ª—è–µ—à—å—Å—è! ‚≠ê
                </div>
              </div>
            )}
          </div>
        </div>
        </>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(MultiplicationGame));
</script>
</body>
</html>
