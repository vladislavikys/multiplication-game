rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // ПРАВИЛА ДЛЯ ПОЛЬЗОВАТЕЛЕЙ
    // ========================================
    match /users/{userId} {
      // Пользователь может читать только свои данные
      // Админы могут читать всех
      allow read: if request.auth != null &&
        (request.auth.uid == userId ||
         request.auth.token.email in [
           'zarya.vlad@yandex.ru'
         ]);

      // Пользователь может создать свой документ при регистрации
      allow create: if request.auth != null && request.auth.uid == userId;

      // Пользователь может обновлять только свои данные
      allow update: if request.auth != null && request.auth.uid == userId
        // Нельзя изменять activatedCodes и blocked напрямую
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['activatedCodes', 'blocked']));

      // Админы могут блокировать/разблокировать пользователей
      allow update: if request.auth != null &&
        request.auth.token.email in [
          'zarya.vlad@yandex.ru'
        ];
    }

    // ========================================
    // ПРАВИЛА ДЛЯ СЕССИЙ (Мониторинг активности)
    // ========================================
    match /sessions/{sessionId} {
      // Пользователь может читать и обновлять только свою сессию
      allow read, write: if request.auth != null && request.auth.uid == sessionId;

      // Админы могут читать все сессии для мониторинга
      allow read: if request.auth != null &&
        request.auth.token.email in [
          'zarya.vlad@yandex.ru'
        ];
    }

    // ========================================
    // ПРАВИЛА ДЛЯ КОДОВ АКТИВАЦИИ
    // ========================================
    match /codes/{codeId} {
      // Все пользователи могут читать коды (для проверки при активации)
      allow read: if request.auth != null;

      // ТОЛЬКО АДМИНЫ могут создавать коды
      // Добавьте email админа в Firebase Authentication
      allow create: if request.auth != null
        && request.auth.token.email in [
          'zarya.vlad@yandex.ru'
        ];

      // Обновление кода разрешено только для активации (пометка used=true)
      allow update: if request.auth != null
        && !resource.data.used  // Код еще не использован
        && request.resource.data.used == true  // Помечаем как использованный
        && request.resource.data.usedBy == request.auth.uid  // Привязываем к текущему пользователю
        && request.resource.data.usedByEmail == request.auth.token.email; // Email совпадает

      // Удаление запрещено
      allow delete: if false;
    }

    // ========================================
    // ЛОГИ БЕЗОПАСНОСТИ
    // ========================================
    match /security_logs/{logId} {
      // Пользователи могут записывать логи (создавать)
      allow create: if request.auth != null;

      // Только админы могут читать логи
      allow read: if request.auth != null &&
        request.auth.token.email in [
          'zarya.vlad@yandex.ru'
        ];

      // Никто не может обновлять или удалять логи
      allow update, delete: if false;
    }
  }
}
