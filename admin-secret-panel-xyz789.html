<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script>
        // üî• –í–ê–®–ê FIREBASE –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–¢–ê –ñ–ï, –ß–¢–û –í index.html)
        const firebaseConfig = {
          apiKey: "AIzaSyCCUcNvmsdh0nsaZler0PQCrqJfNvEHifY",
          authDomain: "multiplication-game-22120.firebaseapp.com",
          projectId: "multiplication-game-22120",
          storageBucket: "multiplication-game-22120.firebasestorage.app",
          messagingSenderId: "797459824775",
          appId: "1:797459824775:web:ce953848b79dd3889b3822"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase (–º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ DOM)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ============================================
        // –ì–õ–ê–í–ù–´–ô –ö–û–î –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–ò
        // ============================================

        let currentUser = null;
        let allCodes = [];
        let codeFilter = 'active'; // 'active' –∏–ª–∏ 'used'
        let userSort = 'newest'; // 'newest', 'oldest', 'licensed', 'free'
        let userFilter = 'all'; // 'all', 'licensed', 'free'

        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π auth listener
        document.addEventListener('DOMContentLoaded', () => {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('auth-section').style.display = 'none';
                    document.getElementById('admin-panel').style.display = 'block';
                    document.getElementById('admin-email').textContent = user.email;
                    await loadAllCodes();
                } else {
                    currentUser = null;
                    document.getElementById('auth-section').style.display = 'block';
                    document.getElementById('admin-panel').style.display = 'none';
                }
            });
        });

        // –í—Ö–æ–¥
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                await auth.signInWithEmailAndPassword(email, password);
                showMessage('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!', 'success');
            } catch (error) {
                showMessage('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message, 'error');
            }
        }

        // –í—ã—Ö–æ–¥
        async function logout() {
            await auth.signOut();
            showMessage('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'info');
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∫–æ–¥–∞
        function generateRandomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            code += '-';
            for (let i = 0; i < 4; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('code').value = code;
        }

        // –î–æ–±–∞–≤–∏—Ç—å –∫–æ–¥
        async function addCode() {
            const code = document.getElementById('code').value.toUpperCase().trim();

            if (!code) {
                showMessage('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥!', 'error');
                return;
            }

            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –∫–æ–¥
                const existingCode = await db.collection('codes').doc(code).get();
                if (existingCode.exists) {
                    showMessage('‚ùå –¢–∞–∫–æ–π –∫–æ–¥ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!', 'error');
                    return;
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–¥ (–±–µ—Å—Å—Ä–æ—á–Ω–∞—è –ª–∏—Ü–µ–Ω–∑–∏—è)
                await db.collection('codes').doc(code).set({
                    used: false,
                    usedBy: null,
                    usedByEmail: null,
                    usedAt: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.email
                });

                showMessage(`‚úÖ –ö–æ–¥ ${code} —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω! (–±–µ—Å—Å—Ä–æ—á–Ω–∞—è –ª–∏—Ü–µ–Ω–∑–∏—è)`, 'success');

                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('code').value = '';

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                await loadAllCodes();

            } catch (error) {
                if (error.code === 'permission-denied') {
                    showMessage('‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–¥–æ–≤! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤–∞—à email —É–∫–∞–∑–∞–Ω –≤ firestore.rules', 'error');
                } else {
                    showMessage('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
                }
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –∫–æ–¥—ã
        async function loadAllCodes() {
            try {
                const snapshot = await db.collection('codes')
                    .orderBy('createdAt', 'desc')
                    .get();

                allCodes = [];
                snapshot.forEach(doc => {
                    allCodes.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                displayCodes();

            } catch (error) {
                console.error('Error loading codes:', error);
                showMessage('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–¥–æ–≤', 'error');
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –∫–æ–¥–æ–≤
        function setCodeFilter(filter) {
            codeFilter = filter;
            document.getElementById('btn-active-codes').className = filter === 'active'
                ? 'px-6 py-3 font-bold text-white bg-green-600 rounded-lg shadow-lg'
                : 'px-6 py-3 font-bold text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300';
            document.getElementById('btn-used-codes').className = filter === 'used'
                ? 'px-6 py-3 font-bold text-white bg-red-600 rounded-lg shadow-lg'
                : 'px-6 py-3 font-bold text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300';
            displayCodes();
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∫–æ–¥—ã
        function displayCodes() {
            const tbody = document.getElementById('codes-list');
            tbody.innerHTML = '';

            const stats = {
                total: allCodes.length,
                used: allCodes.filter(c => c.used).length,
                available: allCodes.filter(c => !c.used).length
            };

            document.getElementById('stat-total').textContent = stats.total;
            document.getElementById('stat-used').textContent = stats.used;
            document.getElementById('stat-available').textContent = stats.available;

            // –§–∏–ª—å—Ç—Ä—É–µ–º –∫–æ–¥—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞
            const filteredCodes = codeFilter === 'active'
                ? allCodes.filter(c => !c.used)
                : allCodes.filter(c => c.used);

            if (filteredCodes.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500 text-xl font-bold">
                    ${codeFilter === 'active' ? 'üìù –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–¥–æ–≤' : '‚úÖ –ù–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤'}
                </td></tr>`;
                return;
            }

            filteredCodes.forEach(code => {
                const row = document.createElement('tr');
                row.className = code.used ? 'bg-red-50' : 'bg-green-50';

                const usedDate = code.usedAt ? new Date(code.usedAt.toDate()).toLocaleString('ru-RU') : '-';
                const createdDate = code.createdAt ? new Date(code.createdAt.toDate()).toLocaleString('ru-RU') : '-';

                row.innerHTML = `
                    <td class="px-4 py-3 font-bold text-lg">${code.id}</td>
                    <td class="px-4 py-3 text-center">
                        ${code.used
                            ? '<span class="bg-red-500 text-white px-3 py-1 rounded-full font-bold">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω</span>'
                            : '<span class="bg-green-500 text-white px-3 py-1 rounded-full font-bold">–î–æ—Å—Ç—É–ø–µ–Ω</span>'}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">${code.usedByEmail || '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${usedDate}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${createdDate}</td>
                    <td class="px-4 py-3 text-center">
                        ${!code.used ? `<button onclick="deleteCode('${code.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded font-bold">–£–¥–∞–ª–∏—Ç—å</button>` : '-'}
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        // –£–¥–∞–ª–∏—Ç—å –∫–æ–¥ (—Ç–æ–ª—å–∫–æ –Ω–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ)
        async function deleteCode(codeId) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–æ–¥ ${codeId}?`)) {
                return;
            }

            try {
                await db.collection('codes').doc(codeId).delete();
                showMessage(`‚úÖ –ö–æ–¥ ${codeId} —É–¥–∞–ª–µ–Ω`, 'success');
                await loadAllCodes();
            } catch (error) {
                showMessage('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message, 'error');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `p-4 rounded-lg font-bold mb-4 ${
                type === 'success' ? 'bg-green-100 text-green-800 border-2 border-green-500' :
                type === 'error' ? 'bg-red-100 text-red-800 border-2 border-red-500' :
                'bg-blue-100 text-blue-800 border-2 border-blue-500'
            }`;
            messageDiv.style.display = 'block';

            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // –ú–∞—Å—Å–æ–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–¥–æ–≤
        async function bulkCreateCodes() {
            const count = parseInt(document.getElementById('bulk-count').value);

            if (!count || count <= 0 || count > 100) {
                showMessage('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç 1 –¥–æ 100', 'error');
                return;
            }

            if (!confirm(`–°–æ–∑–¥–∞—Ç—å ${count} –∫–æ–¥–æ–≤ –±–µ—Å—Å—Ä–æ—á–Ω–æ–π –ª–∏—Ü–µ–Ω–∑–∏–∏?`)) {
                return;
            }

            const createdCodes = [];
            let errors = 0;

            for (let i = 0; i < count; i++) {
                try {
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥
                    let code;
                    let attempts = 0;
                    do {
                        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                        code = '';
                        for (let j = 0; j < 4; j++) {
                            code += chars.charAt(Math.floor(Math.random() * chars.length));
                        }
                        code += '-';
                        for (let j = 0; j < 4; j++) {
                            code += chars.charAt(Math.floor(Math.random() * chars.length));
                        }
                        attempts++;
                    } while (createdCodes.includes(code) && attempts < 10);

                    if (attempts >= 10) {
                        errors++;
                        continue;
                    }

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–¥ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                    const existingCode = await db.collection('codes').doc(code).get();
                    if (existingCode.exists) {
                        errors++;
                        continue;
                    }

                    // –°–æ–∑–¥–∞–µ–º –∫–æ–¥ (–±–µ—Å—Å—Ä–æ—á–Ω–∞—è –ª–∏—Ü–µ–Ω–∑–∏—è)
                    await db.collection('codes').doc(code).set({
                        used: false,
                        usedBy: null,
                        usedByEmail: null,
                        usedAt: null,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: currentUser.email
                    });

                    createdCodes.push(code);

                } catch (error) {
                    console.error('Error creating code:', error);
                    errors++;
                }
            }

            showMessage(`‚úÖ –°–æ–∑–¥–∞–Ω–æ ${createdCodes.length} –∫–æ–¥–æ–≤${errors > 0 ? ` (–æ—à–∏–±–æ–∫: ${errors})` : ''}`, 'success');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∫–æ–¥—ã
            document.getElementById('created-codes-list').textContent = createdCodes.join('\n');

            await loadAllCodes();
        }

        // ============================================
        // –ú–û–ù–ò–¢–û–†–ò–ù–ì –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
        // ============================================

        let allUsers = [];
        let allSessions = [];

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tab) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Å–µ–∫—Ü–∏–∏
            document.getElementById('codes-section').style.display = 'none';
            document.getElementById('users-section').style.display = 'none';
            document.getElementById('security-section').style.display = 'none';

            // –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫
            document.getElementById('tab-codes').className = 'px-6 py-3 font-bold text-gray-500 hover:text-purple-600';
            document.getElementById('tab-users').className = 'px-6 py-3 font-bold text-gray-500 hover:text-purple-600';
            document.getElementById('tab-security').className = 'px-6 py-3 font-bold text-gray-500 hover:text-purple-600';

            // –ü–æ–∫–∞–∑–∞—Ç—å –Ω—É–∂–Ω—É—é —Å–µ–∫—Ü–∏—é
            if (tab === 'codes') {
                document.getElementById('codes-section').style.display = 'block';
                document.getElementById('tab-codes').className = 'px-6 py-3 font-bold text-purple-600 border-b-4 border-purple-600';
            } else if (tab === 'users') {
                document.getElementById('users-section').style.display = 'block';
                document.getElementById('tab-users').className = 'px-6 py-3 font-bold text-purple-600 border-b-4 border-purple-600';
                loadAllUsers();
            } else if (tab === 'security') {
                document.getElementById('security-section').style.display = 'block';
                document.getElementById('tab-security').className = 'px-6 py-3 font-bold text-purple-600 border-b-4 border-purple-600';
                loadSecurityLogs();
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function loadAllUsers() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const usersSnapshot = await db.collection('users').get();
                allUsers = [];
                usersSnapshot.forEach(doc => {
                    allUsers.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–µ—Å—Å–∏–∏
                const sessionsSnapshot = await db.collection('sessions').get();
                allSessions = [];
                sessionsSnapshot.forEach(doc => {
                    allSessions.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // –ü–æ–ª—É—á–∞–µ–º auth –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è email
                const authUsers = {};
                try {
                    // –≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞
                    // –í –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å email –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                } catch (e) {
                    console.log('Cannot fetch auth users');
                }

                displayUsers();

            } catch (error) {
                console.error('Error loading users:', error);
                showMessage('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
            }
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function setUserSort(sort) {
            userSort = sort;
            displayUsers();
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function setUserFilter(filter) {
            userFilter = filter;
            displayUsers();
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function displayUsers() {
            const tbody = document.getElementById('users-list');
            tbody.innerHTML = '';

            // –°—á–∏—Ç–∞–µ–º –æ–Ω–ª–∞–π–Ω (–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –º–∏–Ω—É—Ç—ã)
            const now = Date.now();
            const twoMinutesAgo = now - 2 * 60 * 1000;

            const usersWithSessions = allUsers.map(user => {
                const session = allSessions.find(s => s.userId === user.id);
                return { ...user, session };
            });

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const stats = {
                total: allUsers.length,
                online: usersWithSessions.filter(u => {
                    if (!u.session || !u.session.lastSeen) return false;
                    const lastSeen = u.session.lastSeen.toDate ? u.session.lastSeen.toDate().getTime() : 0;
                    return lastSeen > twoMinutesAgo && u.session.isActive;
                }).length,
                licensed: allUsers.filter(u => u.hasLicense).length,
                free: allUsers.filter(u => !u.hasLicense).length
            };

            document.getElementById('stat-users-total').textContent = stats.total;
            document.getElementById('stat-users-online').textContent = stats.online;
            document.getElementById('stat-users-licensed').textContent = stats.licensed;
            document.getElementById('stat-users-free').textContent = stats.free;

            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            let filteredUsers = usersWithSessions;
            if (userFilter === 'licensed') {
                filteredUsers = filteredUsers.filter(u => u.hasLicense);
            } else if (userFilter === 'free') {
                filteredUsers = filteredUsers.filter(u => !u.hasLicense);
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            filteredUsers.sort((a, b) => {
                if (userSort === 'newest') {
                    // –ù–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É (–ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è)
                    const aTime = a.createdAt?.toDate?.()?.getTime() || 0;
                    const bTime = b.createdAt?.toDate?.()?.getTime() || 0;
                    return bTime - aTime;
                } else if (userSort === 'oldest') {
                    // –°—Ç–∞—Ä—ã–µ —Å–≤–µ—Ä—Ö—É
                    const aTime = a.createdAt?.toDate?.()?.getTime() || 0;
                    const bTime = b.createdAt?.toDate?.()?.getTime() || 0;
                    return aTime - bTime;
                } else if (userSort === 'licensed') {
                    // –° –ª–∏—Ü–µ–Ω–∑–∏–µ–π —Å–≤–µ—Ä—Ö—É
                    return (b.hasLicense ? 1 : 0) - (a.hasLicense ? 1 : 0);
                } else if (userSort === 'free') {
                    // –ë–µ–∑ –ª–∏—Ü–µ–Ω–∑–∏–∏ —Å–≤–µ—Ä—Ö—É
                    return (a.hasLicense ? 1 : 0) - (b.hasLicense ? 1 : 0);
                }
                return 0;
            });

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            filteredUsers.forEach(user => {
                const session = user.session;
                const isOnline = session && session.lastSeen && session.isActive &&
                    session.lastSeen.toDate().getTime() > twoMinutesAgo;

                const row = document.createElement('tr');
                row.className = isOnline ? 'bg-green-50' : 'bg-gray-50';

                const lastSeen = session && session.lastSeen
                    ? new Date(session.lastSeen.toDate()).toLocaleString('ru-RU')
                    : '–ù–∏–∫–æ–≥–¥–∞';

                const deviceInfo = session
                    ? `${session.platform || 'Unknown'} - ${(session.userAgent || '').substring(0, 50)}...`
                    : '-';

                const isBlocked = user.blocked || false;

                row.innerHTML = `
                    <td class="px-4 py-3 text-center">
                        ${isOnline
                            ? '<span class="text-3xl">üü¢</span>'
                            : '<span class="text-3xl">‚ö™</span>'}
                    </td>
                    <td class="px-4 py-3 font-bold">${user.email || user.id}</td>
                    <td class="px-4 py-3 text-center">
                        ${user.hasLicense
                            ? '<span class="bg-green-500 text-white px-3 py-1 rounded-full font-bold">‚úÖ –ï—Å—Ç—å</span>'
                            : '<span class="bg-gray-500 text-white px-3 py-1 rounded-full font-bold">‚ùå –ù–µ—Ç</span>'}
                    </td>
                    <td class="px-4 py-3 text-center">
                        ${isBlocked
                            ? '<span class="bg-red-600 text-white px-3 py-1 rounded-full font-bold">üö´ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù</span>'
                            : '<span class="bg-green-500 text-white px-3 py-1 rounded-full font-bold">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</span>'}
                    </td>
                    <td class="px-4 py-3 text-sm">${session?.ipAddress || '-'}</td>
                    <td class="px-4 py-3 text-xs text-gray-600">${deviceInfo}</td>
                    <td class="px-4 py-3 text-sm">${lastSeen}</td>
                    <td class="px-4 py-3 text-sm font-mono text-xs">${user.activatedCodes?.join(', ') || '-'}</td>
                    <td class="px-4 py-3 text-center">
                        <div class="flex flex-col gap-2">
                            <button
                                onclick="toggleUserBlock('${user.id}', ${isBlocked})"
                                class="px-4 py-2 rounded-lg font-bold text-white shadow-lg transition-all duration-200 hover:scale-105 ${isBlocked ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'}"
                            >
                                ${isBlocked ? '‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : 'üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}
                            </button>
                            <button
                                onclick="resetUserDevices('${user.id}')"
                                class="px-4 py-2 rounded-lg font-bold text-white shadow-lg transition-all duration-200 hover:scale-105 bg-blue-600 hover:bg-blue-700"
                                title="–°–±—Ä–æ—Å–∏—Ç—å —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø–æ–∑–≤–æ–ª–∏—Ç—å –≤–æ–π—Ç–∏ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"
                            >
                                üîÑ –°–±—Ä–æ—Å–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                            </button>
                            <button
                                onclick="deleteUser('${user.id}', '${user.email || user.id}')"
                                class="px-4 py-2 rounded-lg font-bold text-white shadow-lg transition-all duration-200 hover:scale-105 bg-gray-700 hover:bg-gray-800"
                                title="–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª–Ω–æ—Å—Ç—å—é"
                            >
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function toggleUserBlock(userId, currentlyBlocked) {
            const action = currentlyBlocked ? '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';
            const actionPast = currentlyBlocked ? '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω';

            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${action} —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?`)) {
                return;
            }

            try {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
                await db.collection('users').doc(userId).update({
                    blocked: !currentlyBlocked,
                    blockedAt: !currentlyBlocked ? firebase.firestore.FieldValue.serverTimestamp() : null,
                    blockedBy: !currentlyBlocked ? auth.currentUser.email : null
                });

                // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
                await db.collection('security_logs').add({
                    userId: userId,
                    eventType: currentlyBlocked ? 'user_unblocked' : 'user_blocked',
                    details: {
                        adminEmail: auth.currentUser.email,
                        action: currentlyBlocked ? 'unblock' : 'block'
                    },
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // –ï—Å–ª–∏ –±–ª–æ–∫–∏—Ä—É–µ–º - –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (!currentlyBlocked) {
                    await db.collection('sessions').doc(userId).update({
                        isActive: false,
                        blockedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                showMessage(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ ${actionPast}!`, 'success');
                loadAllUsers(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            } catch (error) {
                console.error('Error toggling user block:', error);
                showMessage(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        // –°–±—Ä–æ—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function resetUserDevices(userId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?\n\n–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–æ–π—Ç–∏ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.\n\n–¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è –±—É–¥–µ—Ç –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞.')) {
                return;
            }

            try {
                // –ü–æ–ª—É—á–∞–µ–º email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const userDoc = await db.collection('users').doc(userId).get();
                const userEmail = userDoc.exists ? userDoc.data().email : userId;

                // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é
                const sessionRef = db.collection('sessions').doc(userId);
                const sessionDoc = await sessionRef.get();

                if (sessionDoc.exists) {
                    await sessionRef.update({
                        isActive: false,
                        resetByAdmin: auth.currentUser.email,
                        resetAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ
                await db.collection('security_logs').add({
                    userId: userId,
                    eventType: 'devices_reset_by_admin',
                    details: {
                        adminEmail: auth.currentUser.email,
                        userEmail: userEmail,
                        reason: '–°–±—Ä–æ—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å'
                    },
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                showMessage(`‚úÖ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userEmail} —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω—ã!\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ–∂–µ—Ç –≤–æ–π—Ç–∏ —Å –ª—é–±–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.`, 'success');
                loadAllUsers(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            } catch (error) {
                console.error('Error resetting user devices:', error);
                showMessage(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function deleteUser(userId, userEmail) {
            if (!confirm(`‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –£–î–ê–õ–ò–¢–¨ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userEmail}\n\n–ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã:\n- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n- –°–µ—Å—Å–∏—è\n- –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û!`)) {
                return;
            }

            // –í—Ç–æ—Ä–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
            if (!confirm(`üö® –ü–û–°–õ–ï–î–ù–ï–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï!\n\n–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userEmail}?\n\n–ù–∞–∂–º–∏—Ç–µ –û–ö –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.`)) {
                return;
            }

            try {
                // –£–¥–∞–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await db.collection('users').doc(userId).delete();

                // –£–¥–∞–ª—è–µ–º —Å–µ—Å—Å–∏—é
                await db.collection('sessions').doc(userId).delete();

                // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ
                await db.collection('security_logs').add({
                    userId: userId,
                    eventType: 'user_deleted_by_admin',
                    details: {
                        adminEmail: auth.currentUser.email,
                        userEmail: userEmail,
                        reason: '–£–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å'
                    },
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                showMessage(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userEmail} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!`, 'success');
                loadAllUsers(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            } catch (error) {
                console.error('Error deleting user:', error);
                showMessage(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            if (document.getElementById('users-section').style.display !== 'none') {
                loadAllUsers();
            }
            if (document.getElementById('security-section').style.display !== 'none') {
                loadSecurityLogs();
            }
        }, 10000);

        // ============================================
        // –õ–û–ì–ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò
        // ============================================

        let allSecurityLogs = [];

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        async function loadSecurityLogs() {
            try {
                const logsSnapshot = await db.collection('security_logs')
                    .orderBy('timestamp', 'desc')
                    .limit(100)
                    .get();

                allSecurityLogs = [];
                logsSnapshot.forEach(doc => {
                    allSecurityLogs.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                displaySecurityLogs();

            } catch (error) {
                console.error('Error loading security logs:', error);
                showMessage('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏', 'error');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –ª–æ–≥–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        function displaySecurityLogs() {
            const tbody = document.getElementById('security-logs-list');
            tbody.innerHTML = '';

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const stats = {
                concurrentAttempts: allSecurityLogs.filter(l => l.eventType === 'concurrent_login_attempt').length,
                deviceSwitches: allSecurityLogs.filter(l => l.eventType === 'device_switch').length,
                blocked: allSecurityLogs.filter(l => l.eventType === 'device_limit_exceeded').length,
                total: allSecurityLogs.length
            };

            document.getElementById('stat-concurrent-attempts').textContent = stats.concurrentAttempts;
            document.getElementById('stat-device-switches').textContent = stats.deviceSwitches;
            document.getElementById('stat-blocked').textContent = stats.blocked;
            document.getElementById('stat-total-events').textContent = stats.total;

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ª–æ–≥–∏
            allSecurityLogs.forEach(log => {
                const row = document.createElement('tr');

                // –¶–≤–µ—Ç —Å—Ç—Ä–æ–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏
                if (log.eventType === 'device_limit_exceeded' || log.eventType === 'user_blocked') {
                    row.className = 'bg-red-100';
                } else if (log.eventType === 'concurrent_login_attempt') {
                    row.className = 'bg-orange-100';
                } else if (log.eventType === 'device_switch') {
                    row.className = 'bg-yellow-50';
                } else if (log.eventType === 'user_unblocked') {
                    row.className = 'bg-green-50';
                } else {
                    row.className = 'bg-gray-50';
                }

                const timestamp = log.timestamp
                    ? new Date(log.timestamp.toDate()).toLocaleString('ru-RU')
                    : '-';

                const eventTypeName = {
                    'concurrent_login_attempt': '‚ö†Ô∏è –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—Ö–æ–¥',
                    'device_switch': 'üîÑ –°–º–µ–Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞',
                    'device_limit_exceeded': 'üö´ –õ–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω',
                    'user_blocked': 'üîí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω',
                    'user_unblocked': '‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'
                }[log.eventType] || log.eventType;

                const details = log.details ? JSON.stringify(log.details) : '-';
                const deviceInfo = log.platform || 'Unknown';

                // –ü–æ–ª—É—á–∞–µ–º email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –º–∞—Å—Å–∏–≤–∞ users
                const user = allUsers.find(u => u.id === log.userId);
                const userEmail = user?.email || log.userId;

                row.innerHTML = `
                    <td class="px-4 py-3 text-sm">${timestamp}</td>
                    <td class="px-4 py-3 text-sm font-bold">${userEmail}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-3 py-1 rounded-full font-bold text-xs ${
                            log.eventType === 'device_limit_exceeded' || log.eventType === 'user_blocked' ? 'bg-red-500 text-white' :
                            log.eventType === 'concurrent_login_attempt' ? 'bg-orange-500 text-white' :
                            log.eventType === 'user_unblocked' ? 'bg-green-500 text-white' :
                            'bg-yellow-500 text-white'
                        }">
                            ${eventTypeName}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">${log.ipAddress || '-'}</td>
                    <td class="px-4 py-3 text-xs text-gray-600">${deviceInfo}</td>
                    <td class="px-4 py-3 text-xs text-gray-600 font-mono" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${details}</td>
                `;

                tbody.appendChild(row);
            });

            if (allSecurityLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500 font-bold">üìä –ù–µ—Ç —Å–æ–±—ã—Ç–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</td></tr>';
            }
        }
    </script>

    <div class="min-h-screen p-8">
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div id="message" style="display: none;"></div>

        <!-- –§–û–†–ú–ê –í–•–û–î–ê -->
        <div id="auth-section" class="max-w-md mx-auto">
            <div class="bg-white rounded-lg shadow-lg p-8 border-4 border-purple-400">
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4">üîê</div>
                    <h1 class="text-3xl font-black text-purple-600">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
                    <p class="text-gray-600 mt-2">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞–º–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏</p>
                </div>

                <input id="email" type="email" placeholder="Email –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"
                    class="w-full border-2 border-purple-300 rounded-lg p-3 mb-4 focus:outline-none focus:border-purple-500">

                <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å"
                    class="w-full border-2 border-purple-300 rounded-lg p-3 mb-6 focus:outline-none focus:border-purple-500"
                    onkeypress="if(event.key==='Enter') login()">

                <button onclick="login()"
                    class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 rounded-lg">
                    üîì –í–û–ô–¢–ò
                </button>
            </div>
        </div>

        <!-- –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ -->
        <div id="admin-panel" style="display: none;">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8 border-4 border-purple-400">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-4xl font-black text-purple-600 mb-2">üéÆ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
                        <p class="text-gray-600">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞–º–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏</p>
                        <p class="text-sm text-gray-500 mt-1">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: <span id="admin-email" class="font-bold"></span></p>
                    </div>
                    <button onclick="logout()"
                        class="bg-red-500 hover:bg-red-600 text-white font-bold px-6 py-3 rounded-lg">
                        üö™ –í—ã–π—Ç–∏
                    </button>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∏ -->
                <div class="flex gap-4 mt-6 border-b-2 border-purple-200">
                    <button id="tab-codes" onclick="switchTab('codes')"
                        class="px-6 py-3 font-bold text-purple-600 border-b-4 border-purple-600">
                        üîë –ö–æ–¥—ã –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
                    </button>
                    <button id="tab-users" onclick="switchTab('users')"
                        class="px-6 py-3 font-bold text-gray-500 hover:text-purple-600">
                        üë• –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    </button>
                    <button id="tab-security" onclick="switchTab('security')"
                        class="px-6 py-3 font-bold text-gray-500 hover:text-purple-600">
                        üõ°Ô∏è –õ–æ–≥–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                    </button>
                </div>
            </div>

            <!-- –í–ö–õ–ê–î–ö–ê: –ö–æ–¥—ã –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ -->
            <div id="codes-section">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="grid grid-cols-3 gap-4 mb-8">
                <div class="bg-blue-500 text-white rounded-lg shadow-lg p-6 text-center">
                    <div class="text-4xl font-black" id="stat-total">0</div>
                    <div class="text-sm font-bold mt-2">–í—Å–µ–≥–æ –∫–æ–¥–æ–≤</div>
                </div>
                <div class="bg-green-500 text-white rounded-lg shadow-lg p-6 text-center">
                    <div class="text-4xl font-black" id="stat-available">0</div>
                    <div class="text-sm font-bold mt-2">–î–æ—Å—Ç—É–ø–Ω–æ</div>
                </div>
                <div class="bg-red-500 text-white rounded-lg shadow-lg p-6 text-center">
                    <div class="text-4xl font-black" id="stat-used">0</div>
                    <div class="text-sm font-bold mt-2">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</div>
                </div>
            </div>

            <!-- –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–¥–∞ -->
            <div class="grid grid-cols-2 gap-8 mb-8">
                <!-- –û–¥–∏–Ω–æ—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ -->
                <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-purple-300">
                    <h2 class="text-2xl font-black text-purple-600 mb-4">‚ûï –°–æ–∑–¥–∞—Ç—å –∫–æ–¥</h2>

                    <div class="mb-4">
                        <label class="block text-gray-700 font-bold mb-2">–ö–æ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏:</label>
                        <div class="flex gap-2">
                            <input id="code" type="text" placeholder="XXXX-XXXX" maxlength="9"
                                class="flex-1 border-2 border-purple-300 rounded-lg p-3 font-bold uppercase text-lg focus:outline-none focus:border-purple-500"
                                style="text-transform: uppercase;">
                            <button onclick="generateRandomCode()"
                                class="bg-gray-500 hover:bg-gray-600 text-white font-bold px-4 rounded-lg">
                                üé≤
                            </button>
                        </div>
                    </div>

                    <div class="mb-6 bg-green-50 border-2 border-green-300 rounded-lg p-4">
                        <p class="text-green-800 font-bold text-center">
                            üéâ –ë–µ—Å—Å—Ä–æ—á–Ω–∞—è –ª–∏—Ü–µ–Ω–∑–∏—è<br/>
                            <span class="text-sm">–ö–æ–¥ –¥–∞–µ—Ç –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –Ω–∞–≤—Å–µ–≥–¥–∞</span>
                        </p>
                    </div>

                    <button onclick="addCode()"
                        class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 rounded-lg text-lg">
                        ‚úÖ –°–û–ó–î–ê–¢–¨ –ö–û–î
                    </button>
                </div>

                <!-- –ú–∞—Å—Å–æ–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ -->
                <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-green-300">
                    <h2 class="text-2xl font-black text-green-600 mb-4">‚ö° –ú–∞—Å—Å–æ–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ</h2>

                    <div class="mb-4">
                        <label class="block text-gray-700 font-bold mb-2">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–¥–æ–≤:</label>
                        <input id="bulk-count" type="number" value="10" min="1" max="100"
                            class="w-full border-2 border-green-300 rounded-lg p-3 font-bold text-lg focus:outline-none focus:border-green-500">
                    </div>

                    <div class="mb-6 bg-green-50 border-2 border-green-300 rounded-lg p-4">
                        <p class="text-green-800 font-bold text-center">
                            üéâ –ë–µ—Å—Å—Ä–æ—á–Ω—ã–µ –ª–∏—Ü–µ–Ω–∑–∏–∏<br/>
                            <span class="text-sm">–ö–∞–∂–¥—ã–π –∫–æ–¥ –¥–∞–µ—Ç –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –Ω–∞–≤—Å–µ–≥–¥–∞</span>
                        </p>
                    </div>

                    <button onclick="bulkCreateCodes()"
                        class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg text-lg">
                        ‚ö° –°–û–ó–î–ê–¢–¨ –ü–ê–ö–ï–¢
                    </button>

                    <div class="mt-4">
                        <label class="block text-gray-700 font-bold mb-2">–°–æ–∑–¥–∞–Ω–Ω—ã–µ –∫–æ–¥—ã:</label>
                        <textarea id="created-codes-list" readonly
                            class="w-full h-32 border-2 border-gray-300 rounded-lg p-2 text-sm font-mono bg-gray-50"
                            placeholder="–°–æ–∑–¥–∞–Ω–Ω—ã–µ –∫–æ–¥—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å..."></textarea>
                    </div>
                </div>
            </div>

            <!-- –¢–∞–±–ª–∏—Ü–∞ –∫–æ–¥–æ–≤ -->
            <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-purple-300">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-black text-purple-600">üìã –í—Å–µ –∫–æ–¥—ã</h2>
                    <button onclick="loadAllCodes()"
                        class="bg-blue-500 hover:bg-blue-600 text-white font-bold px-4 py-2 rounded-lg">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>

                <!-- –§–∏–ª—å—Ç—Ä—ã –∫–æ–¥–æ–≤ -->
                <div class="flex gap-4 mb-6 justify-center">
                    <button id="btn-active-codes" onclick="setCodeFilter('active')"
                        class="px-6 py-3 font-bold text-white bg-green-600 rounded-lg shadow-lg">
                        ‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–¥—ã
                    </button>
                    <button id="btn-used-codes" onclick="setCodeFilter('used')"
                        class="px-6 py-3 font-bold text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300">
                        üî¥ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–¥—ã
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-purple-500 text-white">
                            <tr>
                                <th class="px-4 py-3 text-left font-bold">–ö–æ–¥</th>
                                <th class="px-4 py-3 text-center font-bold">–°—Ç–∞—Ç—É—Å</th>
                                <th class="px-4 py-3 text-left font-bold">Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</th>
                                <th class="px-4 py-3 text-left font-bold">–î–∞—Ç–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏</th>
                                <th class="px-4 py-3 text-left font-bold">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                                <th class="px-4 py-3 text-center font-bold">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="codes-list">
                            <!-- –ö–æ–¥—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->
                        </tbody>
                    </table>
                </div>
            </div>
            </div>
            <!-- –ö–æ–Ω–µ—Ü –í–ö–õ–ê–î–ö–ê: –ö–æ–¥—ã –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ -->

            <!-- –í–ö–õ–ê–î–ö–ê: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
            <div id="users-section" style="display: none;">
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
                <div class="grid grid-cols-4 gap-4 mb-8">
                    <div class="bg-green-500 text-white rounded-lg shadow-lg p-6 text-center">
                        <div class="text-4xl font-black" id="stat-users-total">0</div>
                        <div class="text-sm font-bold mt-2">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    </div>
                    <div class="bg-blue-500 text-white rounded-lg shadow-lg p-6 text-center">
                        <div class="text-4xl font-black" id="stat-users-online">0</div>
                        <div class="text-sm font-bold mt-2">üü¢ –û–Ω–ª–∞–π–Ω</div>
                    </div>
                    <div class="bg-purple-500 text-white rounded-lg shadow-lg p-6 text-center">
                        <div class="text-4xl font-black" id="stat-users-licensed">0</div>
                        <div class="text-sm font-bold mt-2">–° –ª–∏—Ü–µ–Ω–∑–∏–µ–π</div>
                    </div>
                    <div class="bg-orange-500 text-white rounded-lg shadow-lg p-6 text-center">
                        <div class="text-4xl font-black" id="stat-users-free">0</div>
                        <div class="text-sm font-bold mt-2">–ë–µ–∑ –ª–∏—Ü–µ–Ω–∑–∏–∏</div>
                    </div>
                </div>

                <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
                <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-purple-300">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-black text-purple-600">üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
                        <button onclick="loadAllUsers()"
                            class="bg-blue-500 hover:bg-blue-600 text-white font-bold px-4 py-2 rounded-lg">
                            üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>

                    <!-- –§–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <!-- –§–∏–ª—å—Ç—Ä -->
                        <div>
                            <label class="block text-sm font-bold text-purple-600 mb-2">üîç –§–∏–ª—å—Ç—Ä:</label>
                            <select onchange="setUserFilter(this.value)"
                                class="w-full px-4 py-2 border-2 border-purple-300 rounded-lg font-bold focus:outline-none focus:border-purple-500">
                                <option value="all">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                                <option value="licensed">‚úÖ –° –ª–∏—Ü–µ–Ω–∑–∏–µ–π</option>
                                <option value="free">‚ùå –ë–µ–∑ –ª–∏—Ü–µ–Ω–∑–∏–∏</option>
                            </select>
                        </div>
                        <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
                        <div>
                            <label class="block text-sm font-bold text-purple-600 mb-2">üìä –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
                            <select onchange="setUserSort(this.value)"
                                class="w-full px-4 py-2 border-2 border-purple-300 rounded-lg font-bold focus:outline-none focus:border-purple-500">
                                <option value="newest">üïê –ù–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É</option>
                                <option value="oldest">üïê –°—Ç–∞—Ä—ã–µ —Å–≤–µ—Ä—Ö—É</option>
                                <option value="licensed">‚úÖ –° –ª–∏—Ü–µ–Ω–∑–∏–µ–π —Å–≤–µ—Ä—Ö—É</option>
                                <option value="free">‚ùå –ë–µ–∑ –ª–∏—Ü–µ–Ω–∑–∏–∏ —Å–≤–µ—Ä—Ö—É</option>
                            </select>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-purple-500 text-white">
                                <tr>
                                    <th class="px-4 py-3 text-left font-bold">–°—Ç–∞—Ç—É—Å</th>
                                    <th class="px-4 py-3 text-left font-bold">Email</th>
                                    <th class="px-4 py-3 text-center font-bold">–õ–∏—Ü–µ–Ω–∑–∏—è</th>
                                    <th class="px-4 py-3 text-center font-bold">–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞</th>
                                    <th class="px-4 py-3 text-left font-bold">IP –∞–¥—Ä–µ—Å</th>
                                    <th class="px-4 py-3 text-left font-bold">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</th>
                                    <th class="px-4 py-3 text-left font-bold">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                                    <th class="px-4 py-3 text-left font-bold">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–¥—ã</th>
                                    <th class="px-4 py-3 text-center font-bold">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="users-list">
                                <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- –ö–æ–Ω–µ—Ü –í–ö–õ–ê–î–ö–ê: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->

            <!-- –í–ö–õ–ê–î–ö–ê: –õ–æ–≥–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ -->
            <div id="security-section" style="display: none;">
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É–≥—Ä–æ–∑ -->
                <div class="grid grid-cols-4 gap-4 mb-8">
                    <div class="bg-red-500 text-white rounded-lg shadow-lg p-6 text-center">
                        <div class="text-4xl font-black" id="stat-concurrent-attempts">0</div>
                        <div class="text-sm font-bold mt-2">‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—Ö–æ–¥–∞</div>
                    </div>
                    <div class="bg-orange-500 text-white rounded-lg shadow-lg p-6 text-center">
                        <div class="text-4xl font-black" id="stat-device-switches">0</div>
                        <div class="text-sm font-bold mt-2">üîÑ –°–º–µ–Ω—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤</div>
                    </div>
                    <div class="bg-yellow-500 text-white rounded-lg shadow-lg p-6 text-center">
                        <div class="text-4xl font-black" id="stat-blocked">0</div>
                        <div class="text-sm font-bold mt-2">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div>
                    </div>
                    <div class="bg-blue-500 text-white rounded-lg shadow-lg p-6 text-center">
                        <div class="text-4xl font-black" id="stat-total-events">0</div>
                        <div class="text-sm font-bold mt-2">üìä –í—Å–µ–≥–æ —Å–æ–±—ã—Ç–∏–π</div>
                    </div>
                </div>

                <!-- –¢–∞–±–ª–∏—Ü–∞ –ª–æ–≥–æ–≤ -->
                <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-red-300">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-black text-red-600">üõ°Ô∏è –õ–æ–≥–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 100)</h2>
                        <button onclick="loadSecurityLogs()"
                            class="bg-blue-500 hover:bg-blue-600 text-white font-bold px-4 py-2 rounded-lg">
                            üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-red-500 text-white">
                                <tr>
                                    <th class="px-4 py-3 text-left font-bold">–í—Ä–µ–º—è</th>
                                    <th class="px-4 py-3 text-left font-bold">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                    <th class="px-4 py-3 text-center font-bold">–¢–∏–ø —Å–æ–±—ã—Ç–∏—è</th>
                                    <th class="px-4 py-3 text-left font-bold">IP –∞–¥—Ä–µ—Å</th>
                                    <th class="px-4 py-3 text-left font-bold">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</th>
                                    <th class="px-4 py-3 text-left font-bold">–î–µ—Ç–∞–ª–∏</th>
                                </tr>
                            </thead>
                            <tbody id="security-logs-list">
                                <!-- –õ–æ–≥–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- –ö–æ–Ω–µ—Ü –í–ö–õ–ê–î–ö–ê: –õ–æ–≥–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ -->
        </div>
    </div>
</body>
</html>
